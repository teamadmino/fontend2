!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("adm.@angular/common"),require("adm.maptalks"),require("adm.three"),require("adm.lodash"),require("adm.rxjs/operators"),require("adm.shared"),require("adm.@angular/core")):"function"==typeof define&&define.amd?define(["adm.@angular/common","adm.maptalks","adm.three","adm.lodash","adm.rxjs/operators","adm.shared","adm.@angular/core"],e):"object"==typeof exports?exports.map=e(require("adm.@angular/common"),require("adm.maptalks"),require("adm.three"),require("adm.lodash"),require("adm.rxjs/operators"),require("adm.shared"),require("adm.@angular/core")):t.map=e(t["adm.@angular/common"],t["adm.maptalks"],t["adm.three"],t["adm.lodash"],t["adm.rxjs/operators"],t["adm.shared"],t["adm.@angular/core"])}("undefined"!=typeof self?self:this,function(t,e,n,r,i,o,a){return function(t){var e={};function n(r){if(e[r])return e[r].exports;var i=e[r]={i:r,l:!1,exports:{}};return t[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=t,n.c=e,n.d=function(t,e,r){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)n.d(r,i,(function(e){return t[e]}).bind(null,i));return r},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="/assets/plugins/map",n(n.s=0)}({0:function(t,e,n){t.exports=n("P+m1")},"0S4P":function(e,n){e.exports=t},"7Fww":function(t,e,n){
/*!
 * maptalks.heatmap v0.6.1
 * LICENSE : MIT
 * (c) 2016-2019 maptalks.org
 */
/*!
 * requires maptalks@^0.25.0 
 */
!function(t,e){"use strict";var n=function(t,e){return function(t){function e(t){if(!(this instanceof e))return new e(t);this._canvas=t="string"==typeof t?document.getElementById(t):t,this._ctx=t.getContext("2d"),this._width=t.width,this._height=t.height,this._max=1,this._data=[]}t.exports=e,e.prototype={defaultRadius:25,defaultGradient:{.4:"blue",.6:"cyan",.7:"lime",.8:"yellow",1:"red"},data:function(t){return this._data=t,this},max:function(t){return this._max=t,this},add:function(t){return this._data.push(t),this},clear:function(){return this._data=[],this},radius:function(t,e){e=void 0===e?15:e;var n=this._circle=this._createCanvas(),r=n.getContext("2d"),i=this._r=t+e;return n.width=n.height=2*i,r.shadowOffsetX=r.shadowOffsetY=2*i,r.shadowBlur=e,r.shadowColor="black",r.beginPath(),r.arc(-i,-i,t,0,2*Math.PI,!0),r.closePath(),r.fill(),this},resize:function(){this._width=this._canvas.width,this._height=this._canvas.height},gradient:function(t){var e=this._createCanvas(),n=e.getContext("2d"),r=n.createLinearGradient(0,0,0,256);for(var i in e.width=1,e.height=256,t)r.addColorStop(+i,t[i]);return n.fillStyle=r,n.fillRect(0,0,1,256),this._grad=n.getImageData(0,0,1,256).data,this},draw:function(t){this._circle||this.radius(this.defaultRadius),this._grad||this.gradient(this.defaultGradient);var e=this._ctx;e.clearRect(0,0,this._width,this._height);for(var n,r=0,i=this._data.length;r<i;r++)n=this._data[r],e.globalAlpha=Math.max(n[2]/this._max,void 0===t?.05:t),e.drawImage(this._circle,n[0]-this._r,n[1]-this._r);var o=e.getImageData(0,0,this._width,this._height);return this._colorize(o.data,this._grad),e.putImageData(o,0,0),this},_colorize:function(t,e){for(var n,r=0,i=t.length;r<i;r+=4)(n=4*t[r+3])&&(t[r]=e[n],t[r+1]=e[n+1],t[r+2]=e[n+2])},_createCanvas:function(){return"undefined"!=typeof document?document.createElement("canvas"):new this._canvas.constructor}}}(e={exports:{}}),e.exports}();function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function o(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):function(t,e){for(var n=Object.getOwnPropertyNames(e),r=0;r<n.length;r++){var i=n[r],o=Object.getOwnPropertyDescriptor(e,i);o&&o.configurable&&void 0===t[i]&&Object.defineProperty(t,i,o)}}(t,e))}var a={max:1,gradient:{.4:"blue",.6:"cyan",.7:"lime",.8:"yellow",1:"red"},radius:25,blur:15,heatValueScale:1,minOpacity:.05},s=function(t){function n(e,o,a){r(this,n),Array.isArray(o)||(a=o,o=null);var s=i(this,t.call(this,e,a));return s._heats=o||[],s}return o(n,t),n.prototype.getData=function(){return this._heats},n.prototype.setData=function(t){return this._heats=t||[],this.redraw()},n.prototype.addPoint=function(t){return t?(t[0]&&Array.isArray(t[0])?e.Util.pushIn(this._heats,t):this._heats.push(t),this.redraw()):this},n.prototype.onConfig=function(t){for(var e in t)if(a[e])return this.redraw();return this},n.prototype.redraw=function(){var t=this._getRenderer();return t&&(t.clearHeatCache(),t.setToRedraw()),this},n.prototype.isEmpty=function(){return!this._heats.length},n.prototype.clear=function(){return this._heats=[],this.redraw(),this.fire("clear"),this},n.prototype.toJSON=function(t){t||(t={});var n={type:this.getJSONType(),id:this.getId(),options:this.config()},r=this.getData();if(t.clipExtent){var i=new e.Extent(t.clipExtent),o=this._getHeatRadius();o&&(i=i._expand(o));for(var a=[],s=0,c=r.length;s<c;s++)i.contains(new e.Coordinate(r[s][0],r[s][1]))&&a.push(r[s]);n.data=a}else n.data=r;return n},n.fromJSON=function(t){return t&&"HeatLayer"===t.type?new n(t.id,t.data,t.options):null},n.prototype._getHeatRadius=function(){return this._getRenderer()?this._getRenderer()._heatRadius:null},n}(e.Layer);s.mergeOptions(a),s.registerJSONType("HeatLayer"),s.registerRenderer("canvas",function(t){function a(){return r(this,a),i(this,t.apply(this,arguments))}return o(a,t),a.prototype.draw=function(){var t=this.getMap(),e=this.layer,r=t.getContainerExtent(),i=this.prepareCanvas(),o=r;if(i){if(!(i=i.convertTo(function(e){return t._pointToContainerPoint(e)})).intersects(r))return void this.completeRender();o=r.intersection(i)}this._heater||(this._heater=n(this.canvas)),this._heater.radius(e.options.radius||this._heater.defaultRadius,e.options.blur),e.options.gradient&&this._heater.gradient(e.options.gradient),this._heater.max(e.options.max),this._heatViews||(this._heatViews=[]);var a=e.getData();if(0!==a.length){var s=this._heatData(a,o);this._heater.data(s).draw(e.options.minOpacity),this.completeRender()}else this.completeRender()},a.prototype.drawOnInteracting=function(){this.draw()},a.prototype._heatData=function(t,n){var r=this.getMap(),i=this.layer,o=r.getProjection(),a=[],s=this._heater._r,c=void 0===i.options.max?1:i.options.max,h=s/2,u=[],l=r.offsetPlatform(),f=l.x%h,d=l.y%h,v=void 0,p=void 0,g=void 0,y=void 0,m=void 0,x=void 0;n=n.expand(s).convertTo(function(t){return new e.Point(r._containerPointToPrj(t))}),this._heatRadius=s;for(var b=0,_=t.length;b<_;b++)v=t[b],this._heatViews[b]||(this._heatViews[b]=o.project(new e.Coordinate(v[0],v[1]))),n.contains(p=this._heatViews[b])&&(p=r._prjToContainerPoint(p),y=Math.floor((p.x-f)/h)+2,m=Math.floor((p.y-d)/h)+2,x=(void 0!==v[2]?+v[2]:.1)*i.options.heatValueScale,u[m]=u[m]||[],(g=u[m][y])?(g[0]=(g[0]*g[2]+p.x*x)/(g[2]+x),g[1]=(g[1]*g[2]+p.y*x)/(g[2]+x),g[2]+=x):u[m][y]=[p.x,p.y,x]);for(var w=0,M=u.length;w<M;w++)if(u[w])for(var O=0,j=u[w].length;O<j;O++)(g=u[w][O])&&a.push([Math.round(g[0]),Math.round(g[1]),Math.min(g[2],c)]);return a},a.prototype.onZoomEnd=function(){delete this._heatViews,t.prototype.onZoomEnd.apply(this,arguments)},a.prototype.onResize=function(){t.prototype.onResize.apply(this,arguments),this.canvas&&(this._heater._width=this.canvas.width,this._heater._height=this.canvas.height)},a.prototype.onRemove=function(){this.clearHeatCache(),delete this._heater},a.prototype.clearHeatCache=function(){delete this._heatViews},a}(e.renderer.CanvasRenderer)),t.HeatLayer=s,Object.defineProperty(t,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.heatmap v0.6.1, requires maptalks@^0.25.0.")}(e,n("V0yk"))},"P+m1":function(t,e,n){"use strict";n.r(e),n.d(e,"MapModule",function(){return v});var r=n("0S4P"),i=n("vOrQ"),o=n("X9qW"),a=n("cfyg"),s=n("aP7H"),c=n("V0yk"),h=n("kH7z"),u=n("7Fww"),l=n("YLtl"),f=["mapRef"],d=function(){function t(t){this.context=t,this.mapElements={},this.pluginConfig=this.context.pluginConfig,this.context.update$.pipe(Object(s.takeUntil)(this.context.destroy$)).subscribe(function(t){})}return t.prototype.pluginOnUpdate=function(t,e,n,r){},t.prototype.createLayers=function(t){for(var e=this,n=function(t){if("ThreeLayer"===t.type){r.mapElements[t.id]&&r.map.removeLayer(r.mapElements[t.id].element);var n=new h.ThreeLayer("t",{forceRenderOnMoving:!0,forceRenderOnRotating:!0});n.prepareToDraw=function(r,i,a){var s=new o.DirectionalLight(16777215);s.position.set(0,-50,10).normalize(),i.add(s);var c=new o.AmbientLight(16777215);i.add(c),n.config("animation",!0),t.config.elements.forEach(function(t){"polygon"===t.type&&(e.mapElements[t.id]&&n.removeMesh(e.mapElements[t.id].element),e.mapElements[t.id]={element:e.drawPolygon(n,t.points,t.color,t.height,t.altitude,t.opacity,t.wireframe),type:t.type},n.addMesh(e.mapElements[t.id].element))})},r.mapElements[t.id]={element:n,type:t.type},n.addTo(r.map),n.setZIndex(t.index)}else if("ImageLayer"===t.type){r.mapElements[t.id]&&r.map.removeLayer(r.mapElements[t.id].element);var i=new c.ImageLayer(t.id,[{url:t.config.url,extent:t.config.extent,opacity:void 0!==t.config.opacity?t.config.opacity:1}]);r.mapElements[t.id]={element:i,type:t.type},r.mapElements[t.id].element.addTo(r.map),i.setZIndex(t.index)}else"TileLayer"===t.type?(r.mapElements[t.id]&&r.map.removeLayer(r.mapElements[t.id].element),i=new c.TileLayer(t.id,t.config),r.mapElements[t.id]={element:i,type:t.type},r.mapElements[t.id].element.addTo(r.map),i.setZIndex(t.index)):"HeatLayer"===t.type&&(r.mapElements[t.id]&&r.map.removeLayer(r.mapElements[t.id].element),i=new u.HeatLayer(t.id,t.config.data),t.config.heatConfig&&i.config(t.config.heatConfig),r.mapElements[t.id]={element:i,type:t.type},r.mapElements[t.id].element.addTo(r.map),i.setZIndex(t.index))},r=this,i=0,a=t;i<a.length;i++)n(a[i])},t.prototype.drawPolygon=function(t,e,n,r,i,a,s){void 0===a&&(a=.9),void 0===s&&(s=!1);var h=new c.Polygon([e],{symbol:{lineColor:n,lineWidth:2,polygonFill:n,polygonOpacity:a},properties:{altitude:r}}),u=new o.MeshPhongMaterial({color:n,transparent:!0,opacity:a});return t.toExtrudePolygon(h,{height:r,topColor:"#ff",altitude:i},u)},t.prototype.ngOnInit=function(){this.jsonMap()},t.prototype.ngAfterViewInit=function(){},t.prototype.jsonMap=function(){var t=this.separateUnsupportedJsonLayers(this.pluginConfig.config.mapConfig.layers),e=Object(l.cloneDeep)(this.pluginConfig.config.mapConfig);e.layers=t.supported,this.map=c.Map.fromJSON(this.mapRef.nativeElement,e),this.createLayers(t.unsupported)},t.prototype.separateUnsupportedJsonLayers=function(t){var e=["ImageLayer","ThreeLayer"],n=[],r=[];return t.forEach(function(t,i){e.indexOf(t.type)>=0?(t.index=i,n.push(t)):r.push(t)}),{supported:r,unsupported:n}},t.prototype.map2=function(){this.map=new c.Map(this.mapRef.nativeElement,{center:void 0!==this.pluginConfig.config.center?this.pluginConfig.config.center:[.5,.5],zoom:void 0!==this.pluginConfig.config.zoom?this.pluginConfig.config.zoom:10,pitch:void 0!==this.pluginConfig.config.pitch?this.pluginConfig.config.pitch:60,bearing:void 0!==this.pluginConfig.config.bearing?this.pluginConfig.config.bearing:-40,fog:!1,dragPitch:!0,dragRotate:!0,dragRotatePitch:!0,zoomControl:!0,scaleControl:!0})},t.prototype.unicodeToChar=function(t){return t.replace(/\u[\dA-Fa-f]{4}/g,function(t){return String.fromCharCode(parseInt(t.replace(/\u/g,""),16))})},t.prototype.createLine=function(t,e,n){return new c.LineString(t,{symbol:{lineColor:n,lineWidth:3,polygonFill:n},properties:{altitude:[e,e]}})},t.prototype.ngOnDestroy=function(){var t=this;this.map.removeBaseLayer(),this.map.getLayers().forEach(function(e){t.map.removeLayer(e)})},t.\u0275fac=function(e){return new(e||t)(i["\u0275\u0275directiveInject"](a.PLUGIN_CONTEXT))},t.\u0275cmp=i["\u0275\u0275defineComponent"]({type:t,selectors:[["app-map"]],viewQuery:function(t,e){var n;1&t&&i["\u0275\u0275staticViewQuery"](f,!0,i.ElementRef),2&t&&i["\u0275\u0275queryRefresh"](n=i["\u0275\u0275loadQuery"]())&&(e.mapRef=n.first)},decls:2,vars:0,consts:[[1,"map"],["mapRef",""]],template:function(t,e){1&t&&i["\u0275\u0275element"](0,"div",0,1)},styles:["[_nghost-%COMP%], [_nghost-%COMP%]   .map[_ngcontent-%COMP%]{width:100%;height:100%}[_nghost-%COMP%]   .map[_ngcontent-%COMP%]{min-width:5px;min-height:5px;position:relative}[_nghost-%COMP%]   .map[_ngcontent-%COMP%]  canvas{min-width:5px;min-height:5px;width:5px;height:5px}"]}),t}(),v=function(){function t(){}return t.entry=d,t.\u0275mod=i["\u0275\u0275defineNgModule"]({type:t}),t.\u0275inj=i["\u0275\u0275defineInjector"]({factory:function(e){return new(e||t)},imports:[[r.CommonModule]]}),t}();e.default=v},V0yk:function(t,n){t.exports=e},X9qW:function(t,e){t.exports=n},YLtl:function(t,e){t.exports=r},aP7H:function(t,e){t.exports=i},cfyg:function(t,e){t.exports=o},kH7z:function(t,e,n){
/*!
 * maptalks.three v0.11.5
 * LICENSE : MIT
 * (c) 2016-2020 maptalks.org
 */
!function(e,r,i){"use strict";var o,a,s="object"==typeof e&&void 0!==t;function c(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,t.__proto__=e}function h(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}r=r,s&&(r=r||n("V0yk")),a=function(t){var e=r,n=r;function r(t,e,n){n=n||2;var r,s,c,h,u,d,v,g=e&&e.length,y=g?e[0]*n:t.length,m=i(t,0,y,n,!0),x=[];if(!m||m.next===m.prev)return x;if(g&&(m=function(t,e,n,r){var a,s,c,h=[];for(a=0,s=e.length;a<s;a++)(c=i(t,e[a]*r,a<s-1?e[a+1]*r:t.length,r,!1))===c.next&&(c.steiner=!0),h.push(p(c));for(h.sort(l),a=0;a<h.length;a++)f(h[a],n),n=o(n,n.next);return n}(t,e,m,n)),t.length>80*n){r=c=t[0],s=h=t[1];for(var b=n;b<y;b+=n)(u=t[b])<r&&(r=u),(d=t[b+1])<s&&(s=d),u>c&&(c=u),d>h&&(h=d);v=0!==(v=Math.max(c-r,h-s))?1/v:0}return a(m,x,n,r,s,v),x}function i(t,e,n,r,i){var o,a;if(i===A(t,e,n,r)>0)for(o=e;o<n;o+=r)a=j(o,t[o],t[o+1],a);else for(o=n-r;o>=e;o-=r)a=j(o,t[o],t[o+1],a);return a&&x(a,a.next)&&(S(a),a=a.next),a}function o(t,e){if(!t)return t;e||(e=t);var n,r=t;do{if(n=!1,r.steiner||!x(r,r.next)&&0!==m(r.prev,r,r.next))r=r.next;else{if(S(r),(r=e=r.prev)===r.next)break;n=!0}}while(n||r!==e);return e}function a(t,e,n,r,i,l,f){if(t){!f&&l&&function(t,e,n,r){var i=t;do{null===i.z&&(i.z=v(i.x,i.y,e,n,r)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next}while(i!==t);i.prevZ.nextZ=null,i.prevZ=null,function(t){var e,n,r,i,o,a,s,c,h=1;do{for(n=t,t=null,o=null,a=0;n;){for(a++,r=n,s=0,e=0;e<h&&(s++,r=r.nextZ);e++);for(c=h;s>0||c>0&&r;)0!==s&&(0===c||!r||n.z<=r.z)?(i=n,n=n.nextZ,s--):(i=r,r=r.nextZ,c--),o?o.nextZ=i:t=i,i.prevZ=o,o=i;n=r}o.nextZ=null,h*=2}while(a>1)}(i)}(t,r,i,l);for(var d,p,g=t;t.prev!==t.next;)if(d=t.prev,p=t.next,l?c(t,r,i,l):s(t))e.push(d.i/n),e.push(t.i/n),e.push(p.i/n),S(t),t=p.next,g=p.next;else if((t=p)===g){f?1===f?a(t=h(o(t),e,n),e,n,r,i,l,2):2===f&&u(t,e,n,r,i,l):a(o(t),e,n,r,i,l,1);break}}}function s(t){var e=t.prev,n=t,r=t.next;if(m(e,n,r)>=0)return!1;for(var i=t.next.next;i!==t.prev;){if(g(e.x,e.y,n.x,n.y,r.x,r.y,i.x,i.y)&&m(i.prev,i,i.next)>=0)return!1;i=i.next}return!0}function c(t,e,n,r){var i=t.prev,o=t,a=t.next;if(m(i,o,a)>=0)return!1;for(var s=i.x>o.x?i.x>a.x?i.x:a.x:o.x>a.x?o.x:a.x,c=i.y>o.y?i.y>a.y?i.y:a.y:o.y>a.y?o.y:a.y,h=v(i.x<o.x?i.x<a.x?i.x:a.x:o.x<a.x?o.x:a.x,i.y<o.y?i.y<a.y?i.y:a.y:o.y<a.y?o.y:a.y,e,n,r),u=v(s,c,e,n,r),l=t.prevZ,f=t.nextZ;l&&l.z>=h&&f&&f.z<=u;){if(l!==t.prev&&l!==t.next&&g(i.x,i.y,o.x,o.y,a.x,a.y,l.x,l.y)&&m(l.prev,l,l.next)>=0)return!1;if(l=l.prevZ,f!==t.prev&&f!==t.next&&g(i.x,i.y,o.x,o.y,a.x,a.y,f.x,f.y)&&m(f.prev,f,f.next)>=0)return!1;f=f.nextZ}for(;l&&l.z>=h;){if(l!==t.prev&&l!==t.next&&g(i.x,i.y,o.x,o.y,a.x,a.y,l.x,l.y)&&m(l.prev,l,l.next)>=0)return!1;l=l.prevZ}for(;f&&f.z<=u;){if(f!==t.prev&&f!==t.next&&g(i.x,i.y,o.x,o.y,a.x,a.y,f.x,f.y)&&m(f.prev,f,f.next)>=0)return!1;f=f.nextZ}return!0}function h(t,e,n){var r=t;do{var i=r.prev,a=r.next.next;!x(i,a)&&b(i,r,r.next,a)&&M(i,a)&&M(a,i)&&(e.push(i.i/n),e.push(r.i/n),e.push(a.i/n),S(r),S(r.next),r=t=a),r=r.next}while(r!==t);return o(r)}function u(t,e,n,r,i,s){var c=t;do{for(var h=c.next.next;h!==c.prev;){if(c.i!==h.i&&y(c,h)){var u=O(c,h);return c=o(c,c.next),u=o(u,u.next),a(c,e,n,r,i,s),void a(u,e,n,r,i,s)}h=h.next}c=c.next}while(c!==t)}function l(t,e){return t.x-e.x}function f(t,e){if(e=function(t,e){var n,r=e,i=t.x,o=t.y,a=-1/0;do{if(o<=r.y&&o>=r.next.y&&r.next.y!==r.y){var s=r.x+(o-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(s<=i&&s>a){if(a=s,s===i){if(o===r.y)return r;if(o===r.next.y)return r.next}n=r.x<r.next.x?r:r.next}}r=r.next}while(r!==e);if(!n)return null;if(i===a)return n;var c,h=n,u=n.x,l=n.y,f=1/0;r=n;do{i>=r.x&&r.x>=u&&i!==r.x&&g(o<l?i:a,o,u,l,o<l?a:i,o,r.x,r.y)&&(c=Math.abs(o-r.y)/(i-r.x),M(r,t)&&(c<f||c===f&&(r.x>n.x||r.x===n.x&&d(n,r)))&&(n=r,f=c)),r=r.next}while(r!==h);return n}(t,e)){var n=O(e,t);o(e,e.next),o(n,n.next)}}function d(t,e){return m(t.prev,t,e.prev)<0&&m(e.next,t,t.next)<0}function v(t,e,n,r,i){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-n)*i)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-r)*i)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function p(t){var e=t,n=t;do{(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next}while(e!==t);return n}function g(t,e,n,r,i,o,a,s){return(i-a)*(e-s)-(t-a)*(o-s)>=0&&(t-a)*(r-s)-(n-a)*(e-s)>=0&&(n-a)*(o-s)-(i-a)*(r-s)>=0}function y(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){var n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&b(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}(t,e)&&(M(t,e)&&M(e,t)&&function(t,e){var n=t,r=!1,i=(t.x+e.x)/2,o=(t.y+e.y)/2;do{n.y>o!=n.next.y>o&&n.next.y!==n.y&&i<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(r=!r),n=n.next}while(n!==t);return r}(t,e)&&(m(t.prev,t,e.prev)||m(t,e.prev,e))||x(t,e)&&m(t.prev,t,t.next)>0&&m(e.prev,e,e.next)>0)}function m(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function x(t,e){return t.x===e.x&&t.y===e.y}function b(t,e,n,r){var i=w(m(t,e,n)),o=w(m(t,e,r)),a=w(m(n,r,t)),s=w(m(n,r,e));return i!==o&&a!==s||!(0!==i||!_(t,n,e))||!(0!==o||!_(t,r,e))||!(0!==a||!_(n,t,r))||!(0!==s||!_(n,e,r))}function _(t,e,n){return e.x<=Math.max(t.x,n.x)&&e.x>=Math.min(t.x,n.x)&&e.y<=Math.max(t.y,n.y)&&e.y>=Math.min(t.y,n.y)}function w(t){return t>0?1:t<0?-1:0}function M(t,e){return m(t.prev,t,t.next)<0?m(t,e,t.next)>=0&&m(t,t.prev,e)>=0:m(t,e,t.prev)<0||m(t,t.next,e)<0}function O(t,e){var n=new C(t.i,t.x,t.y),r=new C(e.i,e.x,e.y),i=t.next,o=e.prev;return t.next=e,e.prev=t,n.next=i,i.prev=n,r.next=n,n.prev=r,o.next=r,r.prev=o,r}function j(t,e,n,r){var i=new C(t,e,n);return r?(i.next=r.next,i.prev=r,r.next.prev=i,r.next=i):(i.prev=i,i.next=i),i}function S(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function C(t,e,n){this.i=t,this.x=e,this.y=n,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function A(t,e,n,r){for(var i=0,o=e,a=n-r;o<n;o+=r)i+=(t[a]-t[o])*(t[o+1]+t[a+1]),a=o;return i}function T(t,e,n){var r=e[0],i=e[1],o=n[0]-r,a=n[1]-i;if(0!==o||0!==a){var s=((t[0]-r)*o+(t[1]-i)*a)/(o*o+a*a);s>1?(r=n[0],i=n[1]):s>0&&(r+=o*s,i+=a*s)}return(o=t[0]-r)*o+(a=t[1]-i)*a}function P(t,e,n,r,i){for(var o,a=r,s=e+1;s<n;s++){var c=T(t[s],t[e],t[n]);c>a&&(o=s,a=c)}a>r&&(o-e>1&&P(t,e,o,r,i),i.push(t[o]),n-o>1&&P(t,o,n,r,i))}function k(t,e){var n=t.length-1,r=[t[0]];return P(t,0,n,e,r),r.push(t[n]),r}function B(t,e,n){if(t.length<=2)return t;var r=void 0!==e?e*e:1;return k(t=n?t:function(t,e){for(var n,r=t[0],i=[r],o=1,a=t.length;o<a;o++)void 0,void 0,(h=(s=n=t[o])[0]-(c=r)[0])*h+(u=s[1]-c[1])*u>e&&(i.push(n),r=n);var s,c,h,u;return r!==n&&i.push(n),i}(t,r),r)}function I(t,e){return t[0]*e[0]+t[1]*e[1]}function L(t,e){var n=e[0],r=e[1],i=Math.sqrt(n*n+r*r);return t[0]=n/i,t[1]=r/i,t}function E(t,e,n,r){return t[0]=e[0]+n[0]*r,t[1]=e[1]+n[1]*r,t[2]=e[2]+n[2]*r,t}function z(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t}function V(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t}function R(t,e){var n=e[0],r=e[1],i=e[2],o=Math.sqrt(n*n+r*r+i*i);return t[0]=n/o,t[1]=r/o,t[2]=i/o,t}function U(t,e,n){var r=e[0],i=e[1],o=e[2],a=n[0],s=n[1],c=n[2];return t[0]=i*c-o*s,t[1]=o*a-r*c,t[2]=r*s-i*a,t}r.deviation=function(t,e,n,r){var i=e&&e.length,o=Math.abs(A(t,0,i?e[0]*n:t.length,n));if(i)for(var a=0,s=e.length;a<s;a++)o-=Math.abs(A(t,e[a]*n,a<s-1?e[a+1]*n:t.length,n));var c=0;for(a=0;a<r.length;a+=3){var h=r[a]*n,u=r[a+1]*n,l=r[a+2]*n;c+=Math.abs((t[h]-t[l])*(t[u+1]-t[h+1])-(t[h]-t[u])*(t[l+1]-t[h+1]))}return 0===o&&0===c?0:Math.abs((c-o)/o)},r.flatten=function(t){for(var e=t[0][0].length,n={vertices:[],holes:[],dimensions:e},r=0,i=0;i<t.length;i++){for(var o=0;o<t[i].length;o++)for(var a=0;a<e;a++)n.vertices.push(t[i][o][a]);i>0&&n.holes.push(r+=t[i-1].length)}return n},e.default=n;var F=[];function Z(t,e,n,r){var i=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}(e,n),o=Math.acos(i)*r;return E(F,n,e,-i),function(t,e){var n=e[0],r=e[1],i=e[2],o=Math.sqrt(n*n+r*r+i*i);t[0]=n/o,t[1]=r/o,t[2]=i/o}(F,F),function(t,e,n){t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n}(t,e,Math.cos(o)),E(t,t,F,Math.sin(o)),t}function G(t,e,n){if(n-e<3)return 0;for(var r=0,i=2*(n-1),o=2*e;o<2*n;){var a=t[i],s=t[i+1],c=t[o],h=t[o+1];i=o,o+=2,r+=a*h-c*s}return r}function D(t,n,r){return void 0===r&&(r=2),e(t,n,r)}var H=[],q=[],W=[];function K(t,e,n,r,i,o,a,s){var c=null!=a,h=i,u=null;c&&(u=new Uint32Array(r-n));for(var l=n;l<r;l++){var f=l===r-1?n:l+1,d=l===n?r-1:l-1,v=t[2*d+1],p=t[2*l],g=t[2*l+1],y=t[2*f],m=t[2*f+1];if(H[0]=p-t[2*d],H[1]=g-v,q[0]=y-p,q[1]=m-g,L(H,H),L(q,q),c&&(u[l]=h),s||l!==n)if(s||l!==r-1){z(W,q,H);var x=W[1];W[1]=-W[0],W[0]=x,L(W,W);var b=I(W,q),_=Math.sqrt(1-b*b),w=o*Math.min(10,1/_);if(c&&1/_>a&&o*b<0){var M=p+W[0]*o,O=g+W[1]*o,j=Math.acos(_)/2,S=Math.tan(j)*Math.abs(o);e[2*h]=M+W[1]*S,e[2*h+1]=O-W[0]*S,e[2*++h]=M-W[1]*S,e[2*h+1]=O+W[0]*S,h++}else e[2*h]=p+W[0]*w,e[2*h+1]=g+W[1]*w,h++}else W[0]=H[1],W[1]=-H[0],L(W,W),e[2*h]=p+W[0]*o,e[2*h+1]=g+W[1]*o,h++;else W[0]=q[1],W[1]=-q[0],L(W,W),e[2*h]=p+W[0]*o,e[2*h+1]=g+W[1]*o,h++}return u}function N(t,e,n,r,i){var o=null!=r?[]:new Float32Array(t.length);if(K(t,o,0,e&&e.length?e[0]:t.length/2,0,n,r,i),e)for(var a=0;a<e.length;a++){var s=e[a];K(t,o,s,e[a+1]||t.length/2,null!=r?o.length/2:s,n,r,i)}return o}function Q(t,e,n,r){for(var i=0;i<Math.floor((r-n)/2);i++)for(var o=0;o<e;o++){var a=(i+n)*e+o,s=(r-i-1)*e+o,c=t[a];t[a]=t[s],t[s]=c}return t}function X(t,e){var n=t.length/2,r=0,i=e&&e.length?e[0]:n;G(t,r,i)>0&&Q(t,2,r,i);for(var o=1;o<(e?e.length:0)+1;o++)G(t,r=e[o-1],i=e[o]||n)<0&&Q(t,2,r,i)}var J=[[0,0],[1,0],[1,1],[0,0],[1,1],[0,1]];function Y(t,e,n,r,i,o){var a=e.vertices,s=e.topVertices,c=e.depth,h=e.rect,u=r-n,l=o.smoothSide?1:2,f=u*l,d=o.smoothBevel?1:2,v=Math.min(c/2,o.bevelSize),p=o.bevelSegments,g=i.vertex,y=Math.max(h.width,h.height,c);if(v>0)for(var m=[0,0,1],x=[],b=[0,0,-1],_=[],w=0,M=new Float32Array(u),O=0;O<2;O++)for(var j=0===O?c-v:v,S=0;S<=p*d;S++){for(var C=0,A=void 0,T=void 0,P=0;P<u;P++){for(var k=0;k<l;k++){var B=2*((P+k)%u+n);x[0]=a[B]-s[B],x[1]=a[B+1]-s[B+1],x[2]=0;var I=Math.sqrt(x[0]*x[0]+x[1]*x[1]);x[0]/=I,x[1]/=I;var L=(Math.floor(S/d)+S%d)/p;0===O?Z(_,m,x,L):Z(_,x,b,L);var E=0===O?L:1-L,z=v*Math.sin(E*Math.PI/2),V=I*Math.cos(E*Math.PI/2),R=v*I/Math.sqrt(z*z+V*V),U=_[0]*R+s[B],F=_[1]*R+s[B+1],G=_[2]*R+j;if(t.position[3*i.vertex]=U,t.position[3*i.vertex+1]=F,t.position[3*i.vertex+2]=G,(P>0||k>0)&&(C+=Math.sqrt((A-U)*(A-U)+(T-F)*(T-F))),S>0||O>0){var D=3*(i.vertex-f),H=t.position[D],q=t.position[D+1],W=t.position[D+2];M[P]+=Math.sqrt((H-U)*(H-U)+(q-F)*(q-F)+(W-G)*(W-G))}t.uv[2*i.vertex]=C/y,t.uv[2*i.vertex+1]=M[P]/y,A=U,T=F,i.vertex++}if(d>1&&S%d||1===d&&S>=1)for(var K=0;K<6;K++){var N=(J[K][0]+P*l)%f,Q=J[K][1]+w;t.indices[i.index++]=(Q-1)*f+N+g}}w++}else for(var X=0;X<2;X++)for(var Y=0===X?c-v:v,$=0,tt=void 0,et=void 0,nt=0;nt<u;nt++)for(var rt=0;rt<l;rt++){var it=2*((nt+rt)%u+n),ot=a[it],at=a[it+1];t.position[3*i.vertex]=ot,t.position[3*i.vertex+1]=at,t.position[3*i.vertex+2]=Y,(nt>0||rt>0)&&($+=Math.sqrt((tt-ot)*(tt-ot)+(et-at)*(et-at))),t.uv[2*i.vertex]=$/y,t.uv[2*i.vertex+1]=Y/y,tt=ot,et=at,i.vertex++}for(var st=v>0?p*d+1:1,ct=0;ct<u;ct++)for(var ht=0;ht<6;ht++){var ut=(J[ht][0]+ct*l)%f,lt=J[ht][1]+st;t.indices[i.index++]=(lt-1)*f+ut+g}}function $(t,e,n,r){var i=t.indices,o=t.vertices,a=t.topVertices,s=t.rect,c=t.depth;if(!(o.length<=4)){for(var h=n.vertex,u=i.length,l=0;l<u;l++)e.indices[n.index++]=h+i[l];for(var f=Math.max(s.width,s.height),d=0;d<(r.excludeBottom?1:2);d++)for(var v=0;v<a.length;v+=2){var p=a[v],g=a[v+1];e.position[3*n.vertex]=p,e.position[3*n.vertex+1]=g,e.position[3*n.vertex+2]=(1-d)*c,e.uv[2*n.vertex]=(p-s.x)/f,e.uv[2*n.vertex+1]=(g-s.y)/f,n.vertex++}if(!r.excludeBottom)for(var y=o.length/2,m=0;m<u;m+=3)for(var x=0;x<3;x++)e.indices[n.index++]=h+y+i[m+2-x]}}function tt(t,e){for(var n=[],r=0;r<t.length;r++){for(var i=t[r],o=[],a=i.length,s=i[a-1][0],c=i[a-1][1],h=0,u=0;u<a;u++){var l=i[u][0],f=i[u][1],d=l-s,v=f-c;(h+=Math.sqrt(d*d+v*v))>e&&(o.push(i[u]),h=0),s=l,c=f}o.length>=3&&n.push(o)}return n.length>0?n:null}function et(t,e){for(var n=[],r=0;r<t.length;r++){var i=t[r];(i=B(i,e,!0)).length>=3&&n.push(i)}return n.length>0?n:null}function nt(t,n){n=Object.assign({},n);for(var r=[1/0,1/0],i=[-1/0,-1/0],o=0;o<t.length;o++)rt(t[o][0],r,i);n.boundingRect=n.boundingRect||{x:r[0],y:r[1],width:i[0]-r[0],height:i[1]-r[1]},function(t){t.depth=t.depth||1,t.bevelSize=t.bevelSize||0,t.bevelSegments=null==t.bevelSegments?2:t.bevelSegments,t.smoothSide=t.smoothSide||!1,t.smoothBevel=t.smoothBevel||!1,t.simplify=t.simplify||0,"number"==typeof t.depth&&(t.bevelSize=Math.min(t.bevelSegments>0?t.bevelSize:0,t.depth/2)),t.bevelSize>0||(t.bevelSegments=0),t.bevelSegments=Math.round(t.bevelSegments);var e=t.boundingRect;if(t.translate=t.translate||[0,0],t.scale=t.scale||[1,1],t.fitRect){var n=null==t.fitRect.x?e.x||0:t.fitRect.x,r=null==t.fitRect.y?e.y||0:t.fitRect.y,i=t.fitRect.width,o=t.fitRect.height;null==i?null!=o?i=o/e.height*e.width:(i=e.width,o=e.height):null==o&&(o=i/e.width*e.height),t.scale=[i/e.width,o/e.height],t.translate=[(n-e.x)*t.scale[0],(r-e.y)*t.scale[1]]}}(n);for(var a=[],s=n.translate||[0,0],c=n.scale||[1,1],h=n.boundingRect,u={x:h.x*c[0]+s[0],y:h.y*c[1]+s[1],width:h.width*c[0],height:h.height*c[1]},l=Math.min(h.width,h.height)/1e5,f=0;f<t.length;f++){var d=tt(t[f],l);if(d){var v=n.simplify/Math.max(c[0],c[1]);if(v>0&&(d=et(d,v)),d){for(var p=e.flatten(d),g=p.vertices,y=p.holes,m=p.dimensions,x=0;x<g.length;)g[x]=g[x++]*c[0]+s[0],g[x]=g[x++]*c[1]+s[1];if(X(g,y),2!==m)throw new Error("Only 2D polygon points are supported");var b=n.bevelSize>0?N(g,y,n.bevelSize,null,!0):g,_=D(b,y,m);a.push({indices:_,vertices:g,topVertices:b,holes:y,rect:u,depth:"function"==typeof n.depth?n.depth(f):n.depth})}}}return function(t,e){for(var n=0,r=0,i=0;i<t.length;i++){var o=t[i],a=o.indices,s=o.holes,c=o.vertices.length/2,h=Math.min(o.depth/2,e.bevelSize)>0?e.bevelSegments:0;n+=a.length*(e.excludeBottom?1:2),r+=c*(e.excludeBottom?1:2);for(var u=2+2*h,l=0,f=0,d=0;d<(s?s.length:0)+1;d++){0===d?f=s&&s.length?s[0]:c:(l=s[d-1],f=s[d]||c),n+=6*(f-l)*(u-1);var v=(f-l)*(e.smoothSide?1:2);r+=v*u+(e.smoothBevel?0:h*v*2)}}for(var p={position:new Float32Array(3*r),indices:new(r>65535?Uint32Array:Uint16Array)(n),uv:new Float32Array(2*r)},g={vertex:0,index:0},y=0;y<t.length;y++)$(t[y],p,g,e);for(var m=0;m<t.length;m++){var x=t[m],b=x.holes,_=x.vertices.length/2,w=0,M=b&&b.length?b[0]:_;if(Y(p,t[m],w,M,g,e),b)for(var O=0;O<b.length;O++)Y(p,t[m],w=b[O],M=b[O+1]||_,g,e)}for(var j=0;j<p.uv.length;j++){var S=p.uv[j];p.uv[j]=S>0&&Math.round(S)===S?1:S%1}return p.normal=function(t,e){function n(t,e,n,r){t[0]=e,t[1]=n,t[2]=r}for(var r=[],i=[],o=[],a=[],s=[],c=[],h=t.length,u=new Float32Array(e.length),l=0;l<h;){var f=3*t[l++],d=3*t[l++],v=3*t[l++];n(r,e[f],e[f+1],e[f+2]),n(i,e[d],e[d+1],e[d+2]),n(o,e[v],e[v+1],e[v+2]),V(a,r,i),V(s,i,o),U(c,a,s);for(var p=0;p<3;p++)u[f+p]=u[f+p]+c[p],u[d+p]=u[d+p]+c[p],u[v+p]=u[v+p]+c[p]}for(var g=0;g<u.length;)n(c,u[g],u[g+1],u[g+2]),R(c,c),u[g++]=c[0],u[g++]=c[1],u[g++]=c[2];return u}(p.indices,p.position),p.boundingRect=t[0]&&t[0].rect,p}(a,n)}function rt(t,e,n){for(var r=0;r<t.length;r++)e[0]=Math.min(t[r][0],e[0]),e[1]=Math.min(t[r][1],e[1]),n[0]=Math.max(t[r][0],n[0]),n[1]=Math.max(t[r][1],n[1])}function it(t){for(var e=new Float32Array(t),n=[],r=0,i=e.length;r<i;r+=2)n.push([e[r],e[r+1]]);return n}function ot(t,e){for(var n=new Float32Array(e),r=0,i=0;i<t.length;++i)n.set(t[i],r),r+=t[i].length;return n}t.initialize=function(){},t.onmessage=function(t,e){var n=t.data,r=n.datas;if("Polygon"===n.type){!function(t){for(var e=t.length,n=0;n<e;n++)for(var r=t[n].data,i=0,o=r.length;i<o;i++)for(var a=r[i],s=0,c=a.length;s<c;s++)t[n].data[i][s]=it(a[s])}(r);var i=function(t){for(var e=t.length,n=[],r=[],i=[],o=0,a=0,s=0,c=0,h=0;h<e;h++){var u=(b=void 0,{position:(b=nt((x=t[h]).data,{depth:x.height})).position,normal:b.normal,uv:b.uv,indices:b.indices}),l=u.position,f=u.normal,d=u.uv,v=u.indices;r.push(u);var p=v.length/3;i[h]=[o+1,o+p],o+=p;var g=l.length/3,y=f.length/3,m=d.length/2;n[h]={position:{count:g,start:a,end:a+3*g},normal:{count:y,start:s,end:s+3*y},uv:{count:m,start:c,end:c+2*m},hide:!1},a+=3*g,s+=3*y,c+=2*m}var x,b,_=function(t){for(var e={},n={},r=0;r<t.length;++r){var i=t[r];for(var o in i)void 0===e[o]&&(e[o]=[],n[o]=0),e[o].push(i[o]),n[o]+=i[o].length}var a={},s=0,c=[];for(var h in e)if("indices"===h)for(var u=e[h],l=0,f=u.length;l<f;l++){for(var d=u[l],v=0,p=d.length;v<p;v++)c.push(d[v]+s);s+=e.position[l].length/3}else{var g=ot(e[h],n[h]);if(!g)return null;a[h]=g}return a.indices=new Uint32Array(c),a}(r);return{position:_.position.buffer,normal:_.normal.buffer,uv:_.uv.buffer,indices:_.indices.buffer,faceMap:i,geometriesAttributes:n}}(r);e(null,i,[i.position,i.normal,i.uv,i.indices])}},Object.defineProperty(t,"__esModule",{value:!0})},o?a(s?t.exports:r):r&&r.registerWorkerAdapter?(r.registerWorkerAdapter("maptalks.three",a),o=!0):console.warn("maptalks.registerWorkerAdapter is not defined,If you need to use ThreeVectorTileLayer,you can npm i maptalks@next,more https://github.com/maptalks/maptalks.js/tree/next");var u=function(t){function e(){return t.apply(this,arguments)||this}return c(e,t),e.prototype.addTo=function(t){if(t instanceof O)return t.on("mousemove",this.onMouseMove,this),t.on("mouseout",this.onMouseOut,this),this._owner=t,this._switchEvents("on"),this.onAdd&&this.onAdd(),this.fire("add"),this;throw new Error("Invalid BaseObject the tooltip is added to.")},e}(r.ui.ToolTip),l=parseInt(i.REVISION);function f(t,e,n){return l>109?t.setAttribute(e,n):t.addAttribute(e,n),t}var d,v=function(){i.InstancedBufferGeometry.call(this),this.type="LineSegmentsGeometry",this.setIndex([0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5]),f(this,"position",new i.Float32BufferAttribute([-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],3)),f(this,"uv",new i.Float32BufferAttribute([-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],2))};v.prototype=Object.assign(Object.create(i.InstancedBufferGeometry.prototype),{constructor:v,isLineSegmentsGeometry:!0,applyMatrix:function(t){var e=this.attributes.instanceStart,n=this.attributes.instanceEnd;return void 0!==e&&(t.applyToBufferAttribute(e),t.applyToBufferAttribute(n),e.data.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this},setPositions:function(t){var e;t instanceof Float32Array?e=t:Array.isArray(t)&&(e=new Float32Array(t));var n=new i.InstancedInterleavedBuffer(e,6,1);return f(this,"instanceStart",new i.InterleavedBufferAttribute(n,3,0)),f(this,"instanceEnd",new i.InterleavedBufferAttribute(n,3,3)),this.computeBoundingBox(),this.computeBoundingSphere(),this},setColors:function(t){var e;t instanceof Float32Array?e=t:Array.isArray(t)&&(e=new Float32Array(t));var n=new i.InstancedInterleavedBuffer(e,6,1);return f(this,"instanceColorStart",new i.InterleavedBufferAttribute(n,3,0)),f(this,"instanceColorEnd",new i.InterleavedBufferAttribute(n,3,3)),this},fromWireframeGeometry:function(t){return this.setPositions(t.attributes.position.array),this},fromEdgesGeometry:function(t){return this.setPositions(t.attributes.position.array),this},fromMesh:function(t){return this.fromWireframeGeometry(new i.WireframeGeometry(t.geometry)),this},fromLineSegements:function(t){var e=t.geometry;return e.isGeometry?this.setPositions(e.vertices):e.isBufferGeometry&&this.setPositions(e.position.array),this},computeBoundingBox:(d=new i.Box3,function(){null===this.boundingBox&&(this.boundingBox=new i.Box3);var t=this.attributes.instanceStart,e=this.attributes.instanceEnd;void 0!==t&&void 0!==e&&(this.boundingBox.setFromBufferAttribute(t),d.setFromBufferAttribute(e),this.boundingBox.union(d))}),computeBoundingSphere:function(){var t=new i.Vector3;return function(){null===this.boundingSphere&&(this.boundingSphere=new i.Sphere),null===this.boundingBox&&this.computeBoundingBox();var e=this.attributes.instanceStart,n=this.attributes.instanceEnd;if(void 0!==e&&void 0!==n){var r=this.boundingSphere.center;this.boundingBox.getCenter(r);for(var o=0,a=0,s=e.count;a<s;a++)t.fromBufferAttribute(e,a),o=Math.max(o,r.distanceToSquared(t)),t.fromBufferAttribute(n,a),o=Math.max(o,r.distanceToSquared(t));this.boundingSphere.radius=Math.sqrt(o),isNaN(this.boundingSphere.radius)&&console.error("THREE.LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}}}(),toJSON:function(){},copy:function(t){return this}});var p={},g={};p.line={linewidth:{value:1},resolution:{value:new i.Vector2(1,1)},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}},g.line={uniforms:i.UniformsUtils.merge([i.UniformsLib.common,i.UniformsLib.fog,p.line]),vertexShader:"\n\t\t#include <common>\n\t\t#include <color_pars_vertex>\n\t\t#include <fog_pars_vertex>\n\t\t#include <logdepthbuf_pars_vertex>\n\t\t#include <clipping_planes_pars_vertex>\n\n\t\tuniform float linewidth;\n\t\tuniform vec2 resolution;\n\n\t\tattribute vec3 instanceStart;\n\t\tattribute vec3 instanceEnd;\n\n\t\tattribute vec3 instanceColorStart;\n\t\tattribute vec3 instanceColorEnd;\n\n\t\tvarying vec2 vUv;\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashScale;\n\t\t\tattribute float instanceDistanceStart;\n\t\t\tattribute float instanceDistanceEnd;\n\t\t\tvarying float vLineDistance;\n\n\t\t#endif\n\n\t\tvoid trimSegment( const in vec4 start, inout vec4 end ) {\n\n\t\t\t// trim end segment so it terminates between the camera plane and the near plane\n\n\t\t\t// conservative estimate of the near plane\n\t\t\tfloat a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column\n\t\t\tfloat b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column\n\t\t\tfloat nearEstimate = - 0.5 * b / a;\n\n\t\t\tfloat alpha = ( nearEstimate - start.z ) / ( end.z - start.z );\n\n\t\t\tend.xyz = mix( start.xyz, end.xyz, alpha );\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\t#ifdef USE_COLOR\n\n\t\t\t\tvColor.xyz = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;\n\n\t\t\t#endif\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tvLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;\n\n\t\t\t#endif\n\n\t\t\tfloat aspect = resolution.x / resolution.y;\n\n\t\t\tvUv = uv;\n\n\t\t\t// camera space\n\t\t\tvec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );\n\t\t\tvec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );\n\n\t\t\t// special case for perspective projection, and segments that terminate either in, or behind, the camera plane\n\t\t\t// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space\n\t\t\t// but we need to perform ndc-space calculations in the shader, so we must address this issue directly\n\t\t\t// perhaps there is a more elegant solution -- WestLangley\n\n\t\t\tbool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column\n\n\t\t\tif ( perspective ) {\n\n\t\t\t\tif ( start.z < 0.0 && end.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( start, end );\n\n\t\t\t\t} else if ( end.z < 0.0 && start.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( end, start );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t// clip space\n\t\t\tvec4 clipStart = projectionMatrix * start;\n\t\t\tvec4 clipEnd = projectionMatrix * end;\n\n\t\t\t// ndc space\n\t\t\tvec2 ndcStart = clipStart.xy / clipStart.w;\n\t\t\tvec2 ndcEnd = clipEnd.xy / clipEnd.w;\n\n\t\t\t// direction\n\t\t\tvec2 dir = ndcEnd - ndcStart;\n\n\t\t\t// account for clip-space aspect ratio\n\t\t\tdir.x *= aspect;\n\t\t\tdir = normalize( dir );\n\n\t\t\t// perpendicular to dir\n\t\t\tvec2 offset = vec2( dir.y, - dir.x );\n\n\t\t\t// undo aspect ratio adjustment\n\t\t\tdir.x /= aspect;\n\t\t\toffset.x /= aspect;\n\n\t\t\t// sign flip\n\t\t\tif ( position.x < 0.0 ) offset *= - 1.0;\n\n\t\t\t// endcaps\n\t\t\tif ( position.y < 0.0 ) {\n\n\t\t\t\toffset += - dir;\n\n\t\t\t} else if ( position.y > 1.0 ) {\n\n\t\t\t\toffset += dir;\n\n\t\t\t}\n\n\t\t\t// adjust for linewidth\n\t\t\toffset *= linewidth;\n\n\t\t\t// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...\n\t\t\toffset /= resolution.y;\n\n\t\t\t// select end\n\t\t\tvec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;\n\n\t\t\t// back to clip space\n\t\t\toffset *= clip.w;\n\n\t\t\tclip.xy += offset;\n\n\t\t\tgl_Position = clip;\n\n\t\t\tvec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation\n\n\t\t\t#include <logdepthbuf_vertex>\n\t\t\t#include <clipping_planes_vertex>\n\t\t\t#include <fog_vertex>\n\n\t\t}\n\t\t",fragmentShader:"\n\t\tuniform vec3 diffuse;\n\t\tuniform float opacity;\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashSize;\n\t\t\tuniform float gapSize;\n\n\t\t#endif\n\n\t\tvarying float vLineDistance;\n\n\t\t#include <common>\n\t\t#include <color_pars_fragment>\n\t\t#include <fog_pars_fragment>\n\t\t#include <logdepthbuf_pars_fragment>\n\t\t#include <clipping_planes_pars_fragment>\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\t#include <clipping_planes_fragment>\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tif ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps\n\n\t\t\t\tif ( mod( vLineDistance, dashSize + gapSize ) > dashSize ) discard; // todo - FIX\n\n\t\t\t#endif\n\n\t\t\tif ( abs( vUv.y ) > 1.0 ) {\n\n\t\t\t\tfloat a = vUv.x;\n\t\t\t\tfloat b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;\n\t\t\t\tfloat len2 = a * a + b * b;\n\n\t\t\t\tif ( len2 > 1.0 ) discard;\n\n\t\t\t}\n\n\t\t\tvec4 diffuseColor = vec4( diffuse, opacity );\n\n\t\t\t#include <logdepthbuf_fragment>\n\t\t\t#include <color_fragment>\n\n\t\t\tgl_FragColor = vec4( diffuseColor.rgb, diffuseColor.a );\n\n\t\t\t#include <premultiplied_alpha_fragment>\n\t\t\t#include <tonemapping_fragment>\n\t\t\t#include <encodings_fragment>\n\t\t\t#include <fog_fragment>\n\n\t\t}\n\t\t"};var y=function(t){i.ShaderMaterial.call(this,{type:"LineMaterial",uniforms:i.UniformsUtils.clone(g.line.uniforms),vertexShader:g.line.vertexShader,fragmentShader:g.line.fragmentShader}),this.dashed=!1,Object.defineProperties(this,{color:{enumerable:!0,get:function(){return this.uniforms.diffuse.value},set:function(t){this.uniforms.diffuse.value=t}},linewidth:{enumerable:!0,get:function(){return this.uniforms.linewidth.value},set:function(t){this.uniforms.linewidth.value=t}},dashScale:{enumerable:!0,get:function(){return this.uniforms.dashScale.value},set:function(t){this.uniforms.dashScale.value=t}},dashSize:{enumerable:!0,get:function(){return this.uniforms.dashSize.value},set:function(t){this.uniforms.dashSize.value=t}},gapSize:{enumerable:!0,get:function(){return this.uniforms.gapSize.value},set:function(t){this.uniforms.gapSize.value=t}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(t){this.uniforms.resolution.value.copy(t)}}}),this.setValues(t)};(y.prototype=Object.create(i.ShaderMaterial.prototype)).constructor=y,y.prototype.isLineMaterial=!0,y.prototype.copy=function(t){return i.ShaderMaterial.prototype.copy.call(this,t),this.color.copy(t.color),this.linewidth=t.linewidth,this.resolution=t.resolution,this};var m,x,b=function(t,e){i.Mesh.call(this),this.type="LineSegments2",this.geometry=void 0!==t?t:new v,this.material=void 0!==e?e:new y({color:16777215*Math.random()})};b.prototype=Object.assign(Object.create(i.Mesh.prototype),{constructor:b,isLineSegments2:!0,computeLineDistances:(m=new i.Vector3,x=new i.Vector3,function(){for(var t=this.geometry,e=t.attributes.instanceStart,n=t.attributes.instanceEnd,r=new Float32Array(2*e.data.count),o=0,a=0,s=e.data.count;o<s;o++,a+=2)m.fromBufferAttribute(e,o),x.fromBufferAttribute(n,o),r[a]=0===a?0:r[a-1],r[a+1]=r[a]+m.distanceTo(x);var c=new i.InstancedInterleavedBuffer(r,2,1);return f(t,"instanceDistanceStart",new i.InterleavedBufferAttribute(c,1,0)),f(t,"instanceDistanceEnd",new i.InterleavedBufferAttribute(c,1,1)),this}),copy:function(t){return this}});var _=function(){v.call(this),this.type="LineGeometry"};_.prototype=Object.assign(Object.create(v.prototype),{constructor:_,isLineGeometry:!0,fromLine:function(t){var e=t.geometry;return e.isGeometry?this.setPositions(e.vertices):e.isBufferGeometry&&this.setPositions(e.position.array),this},copy:function(t){return this}});var w=function(t,e){b.call(this),this.type="Line2",this.geometry=void 0!==t?t:new _,this.material=void 0!==e?e:new y({color:16777215*Math.random()})};w.prototype=Object.assign(Object.create(b.prototype),{constructor:w,isLine2:!0,copy:function(t){return this}});var M={interactive:!0,altitude:0,minZoom:0,maxZoom:30,asynchronous:!1},O=function(t){function e(e){var n;return(n=t.call(this)||this).isBaseObject=!0,n.isAdd=!1,n.object3d=null,n.options={},n.toolTip=null,n.infoWindow=null,n._mouseover=!1,n._showPlayer=null,n._visible=!0,n._zoomVisible=!0,n._vt=null,n.picked=!1,n.pickObject3d=null,void 0===e&&(e=r.Util.GUID()),n.id=e,n}c(e,t);var n=e.prototype;return n.addTo=function(t){return t instanceof _n?t.addMesh(this):console.error("layer only support maptalks.ThreeLayer"),this},n.remove=function(){var t=this.getLayer();return t&&t.removeMesh(this),this},n.getObject3d=function(){return this.object3d},n.getId=function(){return this.id},n.setId=function(t){var e=this.getId();return this.id=t,this._fire("idchange",{old:e,new:t,target:this}),this},n.getType=function(){return this.constructor.name},n.getOptions=function(){return this.options},n.getProperties=function(){return(this.options||{}).properties},n.setProperties=function(t){var e=Object.assign({},this.getProperties());return this.options.properties=t,this._fire("propertieschange",{old:e,new:t,target:this}),this},n.getLayer=function(){return this.options.layer},n.getMap=function(){var t=this.getLayer();if(t)return t.getMap()},n.getCenter=function(){var t=this.getOptions(),e=t.coordinate;if(e)return e;var n=t.polygon||t.lineString;return n&&n.getCenter?n.getCenter():void 0},n.getAltitude=function(){return this.getOptions().altitude},n.setAltitude=function(t){if(r.Util.isNumber(t)){var e=this.getLayer().distanceToVector3(t,t).x;if(this.getObject3d().position.z=e,this.options.altitude=t,this.pickObject3d&&(this.pickObject3d.position.z=e),this._baseObjects&&Array.isArray(this._baseObjects))for(var n=0,i=this._baseObjects.length;n<i;n++)this._baseObjects[n]&&(this._baseObjects[n].getObject3d().position.z=e)}return this},n.show=function(){return this._zoomVisible&&(this.getObject3d().visible=!0,this._fire("show")),this._visible=!0,this},n.hide=function(){return this.getObject3d().visible=!1,this._fire("hide"),this._visible=!1,this},n.isVisible=function(){return!!this.getObject3d().visible},n.getSymbol=function(){return this.getObject3d().material},n.setSymbol=function(t){if(t&&t instanceof i.Material){t.needsUpdate=!0,t.vertexColors=this.getObject3d().material.vertexColors;var e=this.getObject3d().material.clone();this.getObject3d().material=t,this._fire("symbolchange",{old:e,new:t,target:this})}return this},n.setInfoWindow=function(t){return this.removeInfoWindow(),this.infoWindow=new r.ui.InfoWindow(t),this.infoWindow.addTo(this),this},n.getInfoWindow=function(){return this.infoWindow},n.openInfoWindow=function(t){return(t=t||this.getCenter())instanceof r.Coordinate||(t=new r.Coordinate(t)),t&&this.infoWindow&&this.infoWindow.show(t),this},n.closeInfoWindow=function(){return this.infoWindow&&this.infoWindow.hide(),this},n.removeInfoWindow=function(){return this.infoWindow&&this.infoWindow.remove()&&delete this.infoWindow,this},n.setToolTip=function(t,e){return this.removeToolTip(),this.toolTip=new u(t,e),this.toolTip.addTo(this),this},n.getToolTip=function(){return this.toolTip},n.openToolTip=function(t){return(t=t||this.getCenter())instanceof r.Coordinate||(t=new r.Coordinate(t)),t&&this.toolTip&&this.toolTip.show(t),this},n.closeToolTip=function(){return this.toolTip&&this.toolTip.hide(),this},n.removeToolTip=function(){return this.toolTip&&this.toolTip.remove()&&delete this.toolTip,this},n.animateShow=function(t,e){var n=this;void 0===t&&(t={}),this._showPlayer&&this._showPlayer.cancel(),r.Util.isFunction(t)&&(e=t={});var i=this._showPlayer=r.animation.Animation.animate({scale:1},{duration:t.duration||1e3,easing:t.easing||"out"},function(t){var r=t.styles.scale;r>0&&n.getObject3d().scale.set(1,1,r),e&&e(t,r)});return i.play(),i},n.getMinZoom=function(){return this.getOptions().minZoom},n.getMaxZoom=function(){return this.getOptions().maxZoom},n.isAsynchronous=function(){return this.getOptions().asynchronous},n.fire=function(t,e){return this._fire(t,e),this._vt&&this._vt.onSelectMesh&&this._vt.onSelectMesh(t,e),this},n.config=function(){return this},n.setPickObject3d=function(t){return this.pickObject3d=t,this.pickObject3d.__parent=this,this},n._initOptions=function(t){return this.options=r.Util.extend({},M,t),this},n._createMesh=function(t,e){return this.object3d=new i.Mesh(t,e),this.object3d.__parent=this,this},n._createGroup=function(){return this.object3d=new i.Group,this.object3d.__parent=this,this},n._createLine=function(t,e){return this.object3d=new i.Line(t,e),this.object3d.computeLineDistances(),this.object3d.__parent=this,this},n._createLine2=function(t,e){return this.object3d=new w(t,e),this.object3d.computeLineDistances(),this.object3d.__parent=this,this},n._createPoints=function(t,e){return this.object3d=new i.Points(t,e),this.object3d.__parent=this,this},n._createLineSegments=function(t,e){return this.object3d=new i.LineSegments(t,e),this.object3d.computeLineDistances(),this.object3d.__parent=this,this},e}(r.Eventable(function(){}));function j(t){for(var e={},n={},r=0;r<t.length;++r){var o=t[r];for(var a in o)void 0===e[a]&&(e[a]=[],n[a]=0),e[a].push(o[a]),n[a]+=o[a].length}var s={},c=0,h=[];for(var u in e)if("indices"===u)for(var l=e[u],d=0,v=l.length;d<v;d++){for(var p=l[d],g=0,y=p.length;g<y;g++)h.push(p[g]+c);c+=e.position[d].length/3}else{var m=S(e[u],n[u]);if(!m)return null;s[u]=m}s.indices=new Uint32Array(h);var x=s.position,b=s.normal,_=s.uv,w=s.indices,M=new i.BufferGeometry,O=new Float32Array(x.length);return O.fill(1,0,x.length),f(M,"color",new i.BufferAttribute(O,3)),f(M,"normal",new i.BufferAttribute(b,3)),f(M,"position",new i.BufferAttribute(x,3)),_&&_.length&&f(M,"uv",new i.BufferAttribute(_,2)),M.setIndex(new i.BufferAttribute(w,1)),M}function S(t,e){for(var n=new Float32Array(e),r=0,i=0;i<t.length;++i)n.set(t[i],r),r+=t[i].length;return n}var C={};function A(t,e){void 0===e&&(e=!0);var n,r=t.height,o=t.radialSegments,a=t.radius,s=t._radius,c=t._height;if(!e){var h=new i.CylinderBufferGeometry(a,a,r,o,1);h.rotateX(Math.PI/2);for(var u=h.attributes.position.array,l=0,f=u.length;l<f;l+=3)u[l+2]+=r/2;return h}for(var d=0;d<=4;d++){var v=[c+d,s,o].join("-").toString();if(n=C[v])break;if(v=[c-d,s,o].join("-").toString(),n=C[v])break}if(!n){var p=[c,s,o].join("-").toString();(n=C[p]=new i.CylinderBufferGeometry(a,a,r,o,1)).rotateX(Math.PI/2);for(var g=n.attributes.position.array,y=0,m=g.length;y<m;y+=3)g[y+2]+=r/2;return n}return n}function T(t,e,n,r,o){void 0===r&&(r="y"),void 0===o&&(o=0);var a=0;"y"===r?a=1:"z"===r&&(a=2);for(var s=t.attributes.position.array,c=s.length,h=e instanceof i.Color?e:new i.Color(e),u=new i.Color(n),l=[],d=0;d<c;d+=3)s[d+a]>o?l.push(u.r,u.g,u.b):l.push(h.r,h.g,h.b);return f(t,"color",new i.Float32BufferAttribute(l,3,!0)),l}var P={radius:10,height:100,radialSegments:6,altitude:0,topColor:null,bottomColor:"#2d2f61"},k=function(t){function e(e,n,o,a){var s;n=r.Util.extend({},P,n,{layer:a,coordinate:e}),(s=t.call(this)||this)._initOptions(n);var c=n.height,h=n.radius,u=n.topColor,l=n.bottomColor,f=n.altitude;n.height=a.distanceToVector3(c,c).x,n.radius=a.distanceToVector3(h,h).x,n._radius=s.options.radius,n._height=s.options.height,s._h=n.height;var d=A(n);u&&!o.map&&(T(d,l,u,"z",n.height/2),o.vertexColors=i.VertexColors),s._createMesh(d,o);var v=a.distanceToVector3(f,f).x,p=a.coordinateToVector3(e,v);return s.getObject3d().position.copy(p),s}return c(e,t),e}(O),B=L,I=L;function L(t,e,n){n=n||2;var r,i,o,a,s,c,h,u=e&&e.length,l=u?e[0]*n:t.length,f=E(t,0,l,n,!0),d=[];if(!f||f.next===f.prev)return d;if(u&&(f=function(t,e,n,r){var i,o,a,s=[];for(i=0,o=e.length;i<o;i++)(a=E(t,e[i]*r,i<o-1?e[i+1]*r:t.length,r,!1))===a.next&&(a.steiner=!0),s.push(W(a));for(s.sort(G),i=0;i<s.length;i++)D(s[i],n),n=z(n,n.next);return n}(t,e,f,n)),t.length>80*n){r=o=t[0],i=a=t[1];for(var v=n;v<l;v+=n)(s=t[v])<r&&(r=s),(c=t[v+1])<i&&(i=c),s>o&&(o=s),c>a&&(a=c);h=0!==(h=Math.max(o-r,a-i))?1/h:0}return V(f,d,n,r,i,h),d}function E(t,e,n,r,i){var o,a;if(i===ot(t,e,n,r)>0)for(o=e;o<n;o+=r)a=nt(o,t[o],t[o+1],a);else for(o=n-r;o>=e;o-=r)a=nt(o,t[o],t[o+1],a);return a&&X(a,a.next)&&(rt(a),a=a.next),a}function z(t,e){if(!t)return t;e||(e=t);var n,r=t;do{if(n=!1,r.steiner||!X(r,r.next)&&0!==Q(r.prev,r,r.next))r=r.next;else{if(rt(r),(r=e=r.prev)===r.next)break;n=!0}}while(n||r!==e);return e}function V(t,e,n,r,i,o,a){if(t){!a&&o&&function(t,e,n,r){var i=t;do{null===i.z&&(i.z=q(i.x,i.y,e,n,r)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next}while(i!==t);i.prevZ.nextZ=null,i.prevZ=null,function(t){var e,n,r,i,o,a,s,c,h=1;do{for(n=t,t=null,o=null,a=0;n;){for(a++,r=n,s=0,e=0;e<h&&(s++,r=r.nextZ);e++);for(c=h;s>0||c>0&&r;)0!==s&&(0===c||!r||n.z<=r.z)?(i=n,n=n.nextZ,s--):(i=r,r=r.nextZ,c--),o?o.nextZ=i:t=i,i.prevZ=o,o=i;n=r}o.nextZ=null,h*=2}while(a>1)}(i)}(t,r,i,o);for(var s,c,h=t;t.prev!==t.next;)if(s=t.prev,c=t.next,o?U(t,r,i,o):R(t))e.push(s.i/n),e.push(t.i/n),e.push(c.i/n),rt(t),t=c.next,h=c.next;else if((t=c)===h){a?1===a?V(t=F(z(t),e,n),e,n,r,i,o,2):2===a&&Z(t,e,n,r,i,o):V(z(t),e,n,r,i,o,1);break}}}function R(t){var e=t.prev,n=t,r=t.next;if(Q(e,n,r)>=0)return!1;for(var i=t.next.next;i!==t.prev;){if(K(e.x,e.y,n.x,n.y,r.x,r.y,i.x,i.y)&&Q(i.prev,i,i.next)>=0)return!1;i=i.next}return!0}function U(t,e,n,r){var i=t.prev,o=t,a=t.next;if(Q(i,o,a)>=0)return!1;for(var s=i.x>o.x?i.x>a.x?i.x:a.x:o.x>a.x?o.x:a.x,c=i.y>o.y?i.y>a.y?i.y:a.y:o.y>a.y?o.y:a.y,h=q(i.x<o.x?i.x<a.x?i.x:a.x:o.x<a.x?o.x:a.x,i.y<o.y?i.y<a.y?i.y:a.y:o.y<a.y?o.y:a.y,e,n,r),u=q(s,c,e,n,r),l=t.prevZ,f=t.nextZ;l&&l.z>=h&&f&&f.z<=u;){if(l!==t.prev&&l!==t.next&&K(i.x,i.y,o.x,o.y,a.x,a.y,l.x,l.y)&&Q(l.prev,l,l.next)>=0)return!1;if(l=l.prevZ,f!==t.prev&&f!==t.next&&K(i.x,i.y,o.x,o.y,a.x,a.y,f.x,f.y)&&Q(f.prev,f,f.next)>=0)return!1;f=f.nextZ}for(;l&&l.z>=h;){if(l!==t.prev&&l!==t.next&&K(i.x,i.y,o.x,o.y,a.x,a.y,l.x,l.y)&&Q(l.prev,l,l.next)>=0)return!1;l=l.prevZ}for(;f&&f.z<=u;){if(f!==t.prev&&f!==t.next&&K(i.x,i.y,o.x,o.y,a.x,a.y,f.x,f.y)&&Q(f.prev,f,f.next)>=0)return!1;f=f.nextZ}return!0}function F(t,e,n){var r=t;do{var i=r.prev,o=r.next.next;!X(i,o)&&J(i,r,r.next,o)&&tt(i,o)&&tt(o,i)&&(e.push(i.i/n),e.push(r.i/n),e.push(o.i/n),rt(r),rt(r.next),r=t=o),r=r.next}while(r!==t);return z(r)}function Z(t,e,n,r,i,o){var a=t;do{for(var s=a.next.next;s!==a.prev;){if(a.i!==s.i&&N(a,s)){var c=et(a,s);return a=z(a,a.next),c=z(c,c.next),V(a,e,n,r,i,o),void V(c,e,n,r,i,o)}s=s.next}a=a.next}while(a!==t)}function G(t,e){return t.x-e.x}function D(t,e){if(e=function(t,e){var n,r=e,i=t.x,o=t.y,a=-1/0;do{if(o<=r.y&&o>=r.next.y&&r.next.y!==r.y){var s=r.x+(o-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(s<=i&&s>a){if(a=s,s===i){if(o===r.y)return r;if(o===r.next.y)return r.next}n=r.x<r.next.x?r:r.next}}r=r.next}while(r!==e);if(!n)return null;if(i===a)return n;var c,h=n,u=n.x,l=n.y,f=1/0;r=n;do{i>=r.x&&r.x>=u&&i!==r.x&&K(o<l?i:a,o,u,l,o<l?a:i,o,r.x,r.y)&&(c=Math.abs(o-r.y)/(i-r.x),tt(r,t)&&(c<f||c===f&&(r.x>n.x||r.x===n.x&&H(n,r)))&&(n=r,f=c)),r=r.next}while(r!==h);return n}(t,e)){var n=et(e,t);z(e,e.next),z(n,n.next)}}function H(t,e){return Q(t.prev,t,e.prev)<0&&Q(e.next,t,t.next)<0}function q(t,e,n,r,i){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-n)*i)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-r)*i)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function W(t){var e=t,n=t;do{(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next}while(e!==t);return n}function K(t,e,n,r,i,o,a,s){return(i-a)*(e-s)-(t-a)*(o-s)>=0&&(t-a)*(r-s)-(n-a)*(e-s)>=0&&(n-a)*(o-s)-(i-a)*(r-s)>=0}function N(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){var n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&J(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}(t,e)&&(tt(t,e)&&tt(e,t)&&function(t,e){var n=t,r=!1,i=(t.x+e.x)/2,o=(t.y+e.y)/2;do{n.y>o!=n.next.y>o&&n.next.y!==n.y&&i<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(r=!r),n=n.next}while(n!==t);return r}(t,e)&&(Q(t.prev,t,e.prev)||Q(t,e.prev,e))||X(t,e)&&Q(t.prev,t,t.next)>0&&Q(e.prev,e,e.next)>0)}function Q(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function X(t,e){return t.x===e.x&&t.y===e.y}function J(t,e,n,r){var i=$(Q(t,e,n)),o=$(Q(t,e,r)),a=$(Q(n,r,t)),s=$(Q(n,r,e));return i!==o&&a!==s||!(0!==i||!Y(t,n,e))||!(0!==o||!Y(t,r,e))||!(0!==a||!Y(n,t,r))||!(0!==s||!Y(n,e,r))}function Y(t,e,n){return e.x<=Math.max(t.x,n.x)&&e.x>=Math.min(t.x,n.x)&&e.y<=Math.max(t.y,n.y)&&e.y>=Math.min(t.y,n.y)}function $(t){return t>0?1:t<0?-1:0}function tt(t,e){return Q(t.prev,t,t.next)<0?Q(t,e,t.next)>=0&&Q(t,t.prev,e)>=0:Q(t,e,t.prev)<0||Q(t,t.next,e)<0}function et(t,e){var n=new it(t.i,t.x,t.y),r=new it(e.i,e.x,e.y),i=t.next,o=e.prev;return t.next=e,e.prev=t,n.next=i,i.prev=n,r.next=n,n.prev=r,o.next=r,r.prev=o,r}function nt(t,e,n,r){var i=new it(t,e,n);return r?(i.next=r.next,i.prev=r,r.next.prev=i,r.next=i):(i.prev=i,i.next=i),i}function rt(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function it(t,e,n){this.i=t,this.x=e,this.y=n,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function ot(t,e,n,r){for(var i=0,o=e,a=n-r;o<n;o+=r)i+=(t[a]-t[o])*(t[o+1]+t[a+1]),a=o;return i}function at(t,e,n){var r=e[0],i=e[1],o=n[0]-r,a=n[1]-i;if(0!==o||0!==a){var s=((t[0]-r)*o+(t[1]-i)*a)/(o*o+a*a);s>1?(r=n[0],i=n[1]):s>0&&(r+=o*s,i+=a*s)}return(o=t[0]-r)*o+(a=t[1]-i)*a}function st(t,e,n,r,i){for(var o,a=r,s=e+1;s<n;s++){var c=at(t[s],t[e],t[n]);c>a&&(o=s,a=c)}a>r&&(o-e>1&&st(t,e,o,r,i),i.push(t[o]),n-o>1&&st(t,o,n,r,i))}function ct(t,e){var n=t.length-1,r=[t[0]];return st(t,0,n,e,r),r.push(t[n]),r}function ht(t,e,n){if(t.length<=2)return t;var r=void 0!==e?e*e:1;return ct(t=n?t:function(t,e){for(var n,r=t[0],i=[r],o=1,a=t.length;o<a;o++)void 0,void 0,(h=(s=n=t[o])[0]-(c=r)[0])*h+(u=s[1]-c[1])*u>e&&(i.push(n),r=n);var s,c,h,u;return r!==n&&i.push(n),i}(t,r),r)}function ut(t,e){return t[0]*e[0]+t[1]*e[1]}function lt(t,e){var n=e[0],r=e[1],i=Math.sqrt(n*n+r*r);return t[0]=n/i,t[1]=r/i,t}function ft(t,e,n,r){return t[0]=e[0]+n[0]*r,t[1]=e[1]+n[1]*r,t[2]=e[2]+n[2]*r,t}function dt(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t}function vt(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t}function pt(t,e){var n=e[0],r=e[1],i=e[2],o=Math.sqrt(n*n+r*r+i*i);return t[0]=n/o,t[1]=r/o,t[2]=i/o,t}function gt(t,e,n){var r=e[0],i=e[1],o=e[2],a=n[0],s=n[1],c=n[2];return t[0]=i*c-o*s,t[1]=o*a-r*c,t[2]=r*s-i*a,t}L.deviation=function(t,e,n,r){var i=e&&e.length,o=Math.abs(ot(t,0,i?e[0]*n:t.length,n));if(i)for(var a=0,s=e.length;a<s;a++)o-=Math.abs(ot(t,e[a]*n,a<s-1?e[a+1]*n:t.length,n));var c=0;for(a=0;a<r.length;a+=3){var h=r[a]*n,u=r[a+1]*n,l=r[a+2]*n;c+=Math.abs((t[h]-t[l])*(t[u+1]-t[h+1])-(t[h]-t[u])*(t[l+1]-t[h+1]))}return 0===o&&0===c?0:Math.abs((c-o)/o)},L.flatten=function(t){for(var e=t[0][0].length,n={vertices:[],holes:[],dimensions:e},r=0,i=0;i<t.length;i++){for(var o=0;o<t[i].length;o++)for(var a=0;a<e;a++)n.vertices.push(t[i][o][a]);i>0&&n.holes.push(r+=t[i-1].length)}return n},B.default=I;var yt=[];function mt(t,e,n,r){var i=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}(e,n),o=Math.acos(i)*r;return ft(yt,n,e,-i),function(t,e){var n=e[0],r=e[1],i=e[2],o=Math.sqrt(n*n+r*r+i*i);t[0]=n/o,t[1]=r/o,t[2]=i/o}(yt,yt),function(t,e,n){t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n}(t,e,Math.cos(o)),ft(t,t,yt,Math.sin(o)),t}function xt(t,e,n){if(n-e<3)return 0;for(var r=0,i=2*(n-1),o=2*e;o<2*n;){var a=t[i],s=t[i+1],c=t[o],h=t[o+1];i=o,o+=2,r+=a*h-c*s}return r}function bt(t,e,n){return void 0===n&&(n=2),B(t,e,n)}var _t=[],wt=[],Mt=[];function Ot(t,e,n,r,i,o,a,s){var c=null!=a,h=i,u=null;c&&(u=new Uint32Array(r-n));for(var l=n;l<r;l++){var f=l===r-1?n:l+1,d=l===n?r-1:l-1,v=t[2*d+1],p=t[2*l],g=t[2*l+1],y=t[2*f],m=t[2*f+1];if(_t[0]=p-t[2*d],_t[1]=g-v,wt[0]=y-p,wt[1]=m-g,lt(_t,_t),lt(wt,wt),c&&(u[l]=h),s||l!==n)if(s||l!==r-1){dt(Mt,wt,_t);var x=Mt[1];Mt[1]=-Mt[0],Mt[0]=x,lt(Mt,Mt);var b=ut(Mt,wt),_=Math.sqrt(1-b*b),w=o*Math.min(10,1/_);if(c&&1/_>a&&o*b<0){var M=p+Mt[0]*o,O=g+Mt[1]*o,j=Math.acos(_)/2,S=Math.tan(j)*Math.abs(o);e[2*h]=M+Mt[1]*S,e[2*h+1]=O-Mt[0]*S,e[2*++h]=M-Mt[1]*S,e[2*h+1]=O+Mt[0]*S,h++}else e[2*h]=p+Mt[0]*w,e[2*h+1]=g+Mt[1]*w,h++}else Mt[0]=_t[1],Mt[1]=-_t[0],lt(Mt,Mt),e[2*h]=p+Mt[0]*o,e[2*h+1]=g+Mt[1]*o,h++;else Mt[0]=wt[1],Mt[1]=-wt[0],lt(Mt,Mt),e[2*h]=p+Mt[0]*o,e[2*h+1]=g+Mt[1]*o,h++}return u}function jt(t,e,n,r,i){var o=null!=r?[]:new Float32Array(t.length);if(Ot(t,o,0,e&&e.length?e[0]:t.length/2,0,n,r,i),e)for(var a=0;a<e.length;a++){var s=e[a];Ot(t,o,s,e[a+1]||t.length/2,null!=r?o.length/2:s,n,r,i)}return o}function St(t,e,n,r){for(var i=0;i<Math.floor((r-n)/2);i++)for(var o=0;o<e;o++){var a=(i+n)*e+o,s=(r-i-1)*e+o,c=t[a];t[a]=t[s],t[s]=c}return t}function Ct(t,e){var n=t.length/2,r=0,i=e&&e.length?e[0]:n;xt(t,r,i)>0&&St(t,2,r,i);for(var o=1;o<(e?e.length:0)+1;o++)xt(t,r=e[o-1],i=e[o]||n)<0&&St(t,2,r,i)}function At(t){t.depth=t.depth||1,t.bevelSize=t.bevelSize||0,t.bevelSegments=null==t.bevelSegments?2:t.bevelSegments,t.smoothSide=t.smoothSide||!1,t.smoothBevel=t.smoothBevel||!1,t.simplify=t.simplify||0,"number"==typeof t.depth&&(t.bevelSize=Math.min(t.bevelSegments>0?t.bevelSize:0,t.depth/2)),t.bevelSize>0||(t.bevelSegments=0),t.bevelSegments=Math.round(t.bevelSegments);var e=t.boundingRect;if(t.translate=t.translate||[0,0],t.scale=t.scale||[1,1],t.fitRect){var n=null==t.fitRect.x?e.x||0:t.fitRect.x,r=null==t.fitRect.y?e.y||0:t.fitRect.y,i=t.fitRect.width,o=t.fitRect.height;null==i?null!=o?i=o/e.height*e.width:(i=e.width,o=e.height):null==o&&(o=i/e.width*e.height),t.scale=[i/e.width,o/e.height],t.translate=[(n-e.x)*t.scale[0],(r-e.y)*t.scale[1]]}}var Tt=[[0,0],[1,0],[1,1],[0,0],[1,1],[0,1]];function Pt(t,e,n,r,i,o){var a=e.vertices,s=e.topVertices,c=e.depth,h=e.rect,u=r-n,l=o.smoothSide?1:2,f=u*l,d=o.smoothBevel?1:2,v=Math.min(c/2,o.bevelSize),p=o.bevelSegments,g=i.vertex,y=Math.max(h.width,h.height,c);if(v>0)for(var m=[0,0,1],x=[],b=[0,0,-1],_=[],w=0,M=new Float32Array(u),O=0;O<2;O++)for(var j=0===O?c-v:v,S=0;S<=p*d;S++){for(var C=0,A=void 0,T=void 0,P=0;P<u;P++){for(var k=0;k<l;k++){var B=2*((P+k)%u+n);x[0]=a[B]-s[B],x[1]=a[B+1]-s[B+1],x[2]=0;var I=Math.sqrt(x[0]*x[0]+x[1]*x[1]);x[0]/=I,x[1]/=I;var L=(Math.floor(S/d)+S%d)/p;0===O?mt(_,m,x,L):mt(_,x,b,L);var E=0===O?L:1-L,z=v*Math.sin(E*Math.PI/2),V=I*Math.cos(E*Math.PI/2),R=v*I/Math.sqrt(z*z+V*V),U=_[0]*R+s[B],F=_[1]*R+s[B+1],Z=_[2]*R+j;if(t.position[3*i.vertex]=U,t.position[3*i.vertex+1]=F,t.position[3*i.vertex+2]=Z,(P>0||k>0)&&(C+=Math.sqrt((A-U)*(A-U)+(T-F)*(T-F))),S>0||O>0){var G=3*(i.vertex-f),D=t.position[G],H=t.position[G+1],q=t.position[G+2];M[P]+=Math.sqrt((D-U)*(D-U)+(H-F)*(H-F)+(q-Z)*(q-Z))}t.uv[2*i.vertex]=C/y,t.uv[2*i.vertex+1]=M[P]/y,A=U,T=F,i.vertex++}if(d>1&&S%d||1===d&&S>=1)for(var W=0;W<6;W++){var K=(Tt[W][0]+P*l)%f,N=Tt[W][1]+w;t.indices[i.index++]=(N-1)*f+K+g}}w++}else for(var Q=0;Q<2;Q++)for(var X=0===Q?c-v:v,J=0,Y=void 0,$=void 0,tt=0;tt<u;tt++)for(var et=0;et<l;et++){var nt=2*((tt+et)%u+n),rt=a[nt],it=a[nt+1];t.position[3*i.vertex]=rt,t.position[3*i.vertex+1]=it,t.position[3*i.vertex+2]=X,(tt>0||et>0)&&(J+=Math.sqrt((Y-rt)*(Y-rt)+($-it)*($-it))),t.uv[2*i.vertex]=J/y,t.uv[2*i.vertex+1]=X/y,Y=rt,$=it,i.vertex++}for(var ot=v>0?p*d+1:1,at=0;at<u;at++)for(var st=0;st<6;st++){var ct=(Tt[st][0]+at*l)%f,ht=Tt[st][1]+ot;t.indices[i.index++]=(ht-1)*f+ct+g}}function kt(t,e,n,r){var i=t.indices,o=t.vertices,a=t.topVertices,s=t.rect,c=t.depth;if(!(o.length<=4)){for(var h=n.vertex,u=i.length,l=0;l<u;l++)e.indices[n.index++]=h+i[l];for(var f=Math.max(s.width,s.height),d=0;d<(r.excludeBottom?1:2);d++)for(var v=0;v<a.length;v+=2){var p=a[v],g=a[v+1];e.position[3*n.vertex]=p,e.position[3*n.vertex+1]=g,e.position[3*n.vertex+2]=(1-d)*c,e.uv[2*n.vertex]=(p-s.x)/f,e.uv[2*n.vertex+1]=(g-s.y)/f,n.vertex++}if(!r.excludeBottom)for(var y=o.length/2,m=0;m<u;m+=3)for(var x=0;x<3;x++)e.indices[n.index++]=h+y+i[m+2-x]}}function Bt(t,e){for(var n=0,r=0,i=0;i<t.length;i++){var o=t[i],a=o.indices,s=o.holes,c=o.vertices.length/2,h=Math.min(o.depth/2,e.bevelSize)>0?e.bevelSegments:0;n+=a.length*(e.excludeBottom?1:2),r+=c*(e.excludeBottom?1:2);for(var u=2+2*h,l=0,f=0,d=0;d<(s?s.length:0)+1;d++){0===d?f=s&&s.length?s[0]:c:(l=s[d-1],f=s[d]||c),n+=6*(f-l)*(u-1);var v=(f-l)*(e.smoothSide?1:2);r+=v*u+(e.smoothBevel?0:h*v*2)}}for(var p={position:new Float32Array(3*r),indices:new(r>65535?Uint32Array:Uint16Array)(n),uv:new Float32Array(2*r)},g={vertex:0,index:0},y=0;y<t.length;y++)kt(t[y],p,g,e);for(var m=0;m<t.length;m++){var x=t[m],b=x.holes,_=x.vertices.length/2,w=0,M=b&&b.length?b[0]:_;if(Pt(p,t[m],w,M,g,e),b)for(var O=0;O<b.length;O++)Pt(p,t[m],w=b[O],M=b[O+1]||_,g,e)}for(var j=0;j<p.uv.length;j++){var S=p.uv[j];p.uv[j]=S>0&&Math.round(S)===S?1:S%1}return p.normal=function(t,e){function n(t,e,n,r){t[0]=e,t[1]=n,t[2]=r}for(var r=[],i=[],o=[],a=[],s=[],c=[],h=t.length,u=new Float32Array(e.length),l=0;l<h;){var f=3*t[l++],d=3*t[l++],v=3*t[l++];n(r,e[f],e[f+1],e[f+2]),n(i,e[d],e[d+1],e[d+2]),n(o,e[v],e[v+1],e[v+2]),vt(a,r,i),vt(s,i,o),gt(c,a,s);for(var p=0;p<3;p++)u[f+p]=u[f+p]+c[p],u[d+p]=u[d+p]+c[p],u[v+p]=u[v+p]+c[p]}for(var g=0;g<u.length;)n(c,u[g],u[g+1],u[g+2]),pt(c,c),u[g++]=c[0],u[g++]=c[1],u[g++]=c[2];return u}(p.indices,p.position),p.boundingRect=t[0]&&t[0].rect,p}function It(t,e,n){for(var r=n.lineWidth,i=t.length,o=new Float32Array(2*i),a=n.translate||[0,0],s=n.scale||[1,1],c=0,h=0;c<i;c++)o[h++]=t[c][0]*s[0]+a[0],o[h++]=t[c][1]*s[1]+a[1];xt(o,0,i)<0&&St(o,2,0,i);var u=[],l=[],f=n.miterLimit,d=Ot(o,l,0,i,0,-r/2,f,!1);St(o,2,0,i);for(var v=Ot(o,u,0,i,0,-r/2,f,!1),p=(u.length+l.length)/2,g=new Float32Array(2*p),y=0,m=l.length/2,x=0;x<l.length;x++)g[y++]=l[x];for(var b=0;b<u.length;b++)g[y++]=u[b];for(var _=new(p>65535?Uint32Array:Uint16Array)(3*(2*(i-1)+(p-2*i))),w=0,M=0;M<i-1;M++){var O=M+1;_[w++]=m-1-d[M],_[w++]=m-1-d[M]-1,_[w++]=v[M]+1+m,_[w++]=m-1-d[M],_[w++]=v[M]+1+m,_[w++]=v[M]+m,v[O]-v[M]==2?(_[w++]=v[M]+2+m,_[w++]=v[M]+1+m,_[w++]=m-d[O]-1):d[O]-d[M]==2&&(_[w++]=v[O]+m,_[w++]=m-1-(d[M]+1),_[w++]=m-1-(d[M]+2))}var j=n.bevelSize>0?jt(g,[],n.bevelSize,null,!0):g,S=n.boundingRect;return{vertices:g,indices:_,topVertices:j,rect:{x:S.x*s[0]+a[0],y:S.y*s[1]+a[1],width:S.width*s[0],height:S.height*s[1]},depth:"function"==typeof n.depth?n.depth(e):n.depth,holes:[]}}function Lt(t,e){for(var n=[],r=0;r<t.length;r++){for(var i=t[r],o=[],a=i.length,s=i[a-1][0],c=i[a-1][1],h=0,u=0;u<a;u++){var l=i[u][0],f=i[u][1],d=l-s,v=f-c;(h+=Math.sqrt(d*d+v*v))>e&&(o.push(i[u]),h=0),s=l,c=f}o.length>=3&&n.push(o)}return n.length>0?n:null}function Et(t,e){for(var n=[],r=0;r<t.length;r++){var i=t[r];(i=ht(i,e,!0)).length>=3&&n.push(i)}return n.length>0?n:null}function zt(t,e){e=Object.assign({},e);for(var n=[1/0,1/0],r=[-1/0,-1/0],i=0;i<t.length;i++)Vt(t[i],n,r);e.boundingRect=e.boundingRect||{x:n[0],y:n[1],width:r[0]-n[0],height:r[1]-n[1]},At(e);var o=e.scale||[1,1];null==e.lineWidth&&(e.lineWidth=1),null==e.miterLimit&&(e.miterLimit=2);for(var a=[],s=0;s<t.length;s++){var c=t[s],h=e.simplify/Math.max(o[0],o[1]);h>0&&(c=ht(c,h,!0)),a.push(It(c,s,e))}return Bt(a,e)}function Vt(t,e,n){for(var r=0;r<t.length;r++)e[0]=Math.min(t[r][0],e[0]),e[1]=Math.min(t[r][1],e[1]),n[0]=Math.max(t[r][0],n[0]),n[1]=Math.max(t[r][1],n[1])}var Rt=["Point","MultiPoint","LineString","MultiLineString","Polygon","MultiPolygon"];function Ut(t){return void 0===t&&(t={}),(t.geometry||{}).type}function Ft(t){void 0===t&&(t={});var e=Ut(t);if(e)for(var n=0,r=Rt.length;n<r;n++)if(Rt[n]===e)return!0;return!1}function Zt(t){void 0===t&&(t={});var e=Ut(t);return!(!e||e!==Rt[4]&&e!==Rt[5])}function Gt(t){void 0===t&&(t={});var e=Ut(t);return!(!e||e!==Rt[2]&&e!==Rt[3])}function Dt(t){void 0===t&&(t={});var e=Ut(t);return!(!e||e!==Rt[0]&&e!==Rt[1])}function Ht(t){return void 0===t&&(t={}),(t.geometry||{}).coordinates||[]}function qt(t){void 0===t&&(t={});var e=Ut(t);if(!e)return null;var n=(t.geometry||{}).coordinates;if(!n)return null;var i=[];switch(e){case"Point":i.push(n);break;case"MultiPoint":case"LineString":for(var o=0,a=n.length;o<a;o++)i.push(n[o]);break;case"MultiLineString":case"Polygon":for(var s=0,c=n.length;s<c;s++)for(var h=0,u=n[s].length;h<u;h++)i.push(n[s][h]);break;case"MultiPolygon":for(var l=0,f=n.length;l<f;l++)for(var d=0,v=n[l].length;d<v;d++)for(var p=0,g=n[l][d].length;p<g;p++)i.push(n[l][d][p])}for(var y=1/0,m=1/0,x=-1/0,b=-1/0,_=0,w=i.length;_<w;_++){var M=i[_],O=M[0],j=M[1];y=Math.min(y,O),m=Math.min(m,j),x=Math.max(x,O),b=Math.max(b,j)}return new r.Coordinate((y+x)/2,(m+b)/2)}function Wt(t){void 0===t&&(t={});var e=Ut(t);if(!e)return null;var n=t.properties||{},r=(t.geometry||{}).coordinates;if(!r)return null;var i,o=[];switch(e){case"MultiPoint":i="Point";break;case"MultiLineString":i="LineString";break;case"MultiPolygon":i="Polygon"}if(i)for(var a=0,s=r.length;a<s;a++)o.push({type:"Feature",geometry:{type:i,coordinates:r[a]},properties:n});else o.push(t);return o}function Kt(t,e,n){var o=[],a=[];if(Array.isArray(t)&&t[0]instanceof i.Vector3)for(var s=0,c=t.length;s<c;s++){var h=t[s];o.push(h.x,h.y,h.z),a.push(h)}else{var u,l;Array.isArray(t)&&(t=new r.LineString(t)),Ft(t)?(u=Ht(t),l=qt(t)):(u=t.getCoordinates(),l=t.getCenter());for(var f=e.coordinateToVector3(n||l),d=0,v=u.length;d<v;d++){var p=u[d];Array.isArray(p)&&(p=new r.Coordinate(p));var g=e.coordinateToVector3(p,0).sub(f);o.push(g.x,g.y,g.z),a.push(g)}}return{positions:o,positionsV:a}}function Nt(t,e,n,r){for(var i=[],o=[],a=[],s=0,c=t.length;s<c;s++)for(var h=t[s],u=0,l=h.length;u<l;u++){var f=h[u];a.length>0?f.join(",").toString()!==a[a.length-1].join(",").toString()&&a.push(f):a.push(f)}for(var d=0,v=a.length;d<v;d++){var p,g=a[d],y=g.join(",").toString();p=n&&n[y]?n[y]:e.coordinateToVector3(g,0).sub(r),o.push(p),i.push(p.x,p.y,p.z)}return{positions:i,positionsV:o,lnglats:a}}function Qt(t,e,n,r,i){void 0===e&&(e=1),void 0===n&&(n=1);for(var o=Kt(t,r,i).positionsV,a=[],s=0,c=o.length;s<c;s++){var h=o[s];a.push([h.x,h.y])}var u=zt([a],{lineWidth:e,depth:n});return{position:u.position,normal:u.normal,indices:u.indices,uv:u.uv}}var Xt={altitude:0,colors:null},Jt=function(t){function e(e,n,o,a){var s;n=r.Util.extend({},Xt,n,{layer:a,lineString:e}),(s=t.call(this)||this)._initOptions(n);var c=Kt(e,a).positions,h=new i.BufferGeometry;f(h,"position",new i.Float32BufferAttribute(c,3));var u=function(t){var e=[];return t&&t.length&&t.forEach(function(t){t=t instanceof i.Color?t:new i.Color(t),e.push(t.r,t.g,t.b)}),e}(n.colors);u&&u.length&&(f(h,"color",new i.Float32BufferAttribute(u,3)),o.vertexColors=i.VertexColors),s._createLine(h,o);var l=n.altitude,d=Ft(e)?qt(e):e.getCenter(),v=a.distanceToVector3(l,l).x,p=a.coordinateToVector3(d,v);return s.getObject3d().position.copy(p),s}return c(e,t),e}(O),Yt={width:3,height:1,altitude:0},$t=function(t){function e(e,n,o,a){var s;n=r.Util.extend({},Yt,n,{layer:a,lineString:e}),(s=t.call(this)||this)._initOptions(n);var c=n.height,h=n.width;n.height=a.distanceToVector3(c,c).x,n.width=a.distanceToVector3(h,h).x;var u=function(t,e,n,r,o){void 0===e&&(e=1),void 0===n&&(n=1);for(var a=Kt(t,r,void 0).positionsV,s=[],c=0,h=a.length;c<h;c++){var u=a[c];s.push([u.x,u.y])}var l=zt([s],{lineWidth:e,depth:n}),d=l.indices,v=l.position,p=l.normal,g=l.uv,y=new i.BufferGeometry;return f(y,"position",new i.Float32BufferAttribute(v,3)),f(y,"normal",new i.Float32BufferAttribute(p,3)),f(y,"uv",new i.Float32BufferAttribute(g,2)),y.setIndex(new i.Uint32BufferAttribute(d,1)),y}(e,n.width,n.height,a);s._createMesh(u,o);var l=n.altitude,d=Ft(e)?qt(e):e.getCenter(),v=a.distanceToVector3(l,l).x,p=a.coordinateToVector3(d,v);return s.getObject3d().position.copy(p),s}return c(e,t),e}(O);function te(t,e,n,r,i){var o=re(t,n,r);if(!o)return null;i?(null==i[e]&&(i[e]=n.distanceToVector3(e,e).x),e=i[e]):e=n.distanceToVector3(e,e).x;var a=function(t,e){e=Object.assign({},e);for(var n=[1/0,1/0],r=[-1/0,-1/0],i=0;i<t.length;i++)Vt(t[i][0],n,r);e.boundingRect=e.boundingRect||{x:n[0],y:n[1],width:r[0]-n[0],height:r[1]-n[1]},At(e);for(var o=[],a=e.translate||[0,0],s=e.scale||[1,1],c=e.boundingRect,h={x:c.x*s[0]+a[0],y:c.y*s[1]+a[1],width:c.width*s[0],height:c.height*s[1]},u=Math.min(c.width,c.height)/1e5,l=0;l<t.length;l++){var f=Lt(t[l],u);if(f){var d=e.simplify/Math.max(s[0],s[1]);if(d>0&&(f=Et(f,d)),f){for(var v=B.flatten(f),p=v.vertices,g=v.holes,y=v.dimensions,m=0;m<p.length;)p[m]=p[m++]*s[0]+a[0],p[m]=p[m++]*s[1]+a[1];if(Ct(p,g),2!==y)throw new Error("Only 2D polygon points are supported");var x=e.bevelSize>0?jt(p,g,e.bevelSize,null,!0):p,b=bt(x,g,y);o.push({indices:b,vertices:p,topVertices:x,holes:g,rect:h,depth:"function"==typeof e.depth?e.depth(l):e.depth})}}}return Bt(o,e)}(o,{depth:e});return{position:a.position,normal:a.normal,uv:a.uv,indices:a.indices}}function ee(t,e,n){for(var r=t.attributes.position.array,o=r.length,a=e instanceof i.Color?e:new i.Color(e),s=new i.Color(n),c=[],h=0;h<o;h+=3)r[h+2]>0?c.push(s.r,s.g,s.b):c.push(a.r,a.g,a.b);return f(t,"color",new i.Float32BufferAttribute(c,3,!0)),c}function ne(t){void 0===t&&(t=[]);for(var e=1/0,n=1/0,i=-1/0,o=-1/0,a=0,s=t.length;a<s;a++){var c=t[a],h=void 0,u=void 0;Array.isArray(c)?(h=c[0],u=c[1]):c instanceof r.Coordinate&&(h=c.x,u=c.y),e=Math.min(e,h),n=Math.min(n,u),i=Math.max(i,h),o=Math.max(o,u)}return new r.Coordinate((e+i)/2,(n+o)/2)}function re(t,e,n,i){if(void 0===i&&(i=!1),!t)return null;var o=[];if(t instanceof r.MultiPolygon)o=t.getGeometries().map(function(r){return ie(r,e,n||t.getCenter(),i)});else if(t instanceof r.Polygon){var a=ie(t,e,n||t.getCenter(),i);o.push(a)}else if(Zt(t)){var s=qt(t);if(function(t){void 0===t&&(t={});var e=Ut(t);return!!(e&&e.indexOf("Multi")>-1)}(t))for(var c=Wt(t),h=0,u=c.length;h<u;h++)o.push(ie(c[h],e,n||s,i));else{var l=ie(t,e,n||s,i);o.push(l)}}return o}function ie(t,e,n,r){var i,o;if(void 0===r&&(r=!1),Zt(t)){var a=Ht(t);i=a[0],o=a.slice(1,a.length),n=n||qt(t)}else i=t.getShell(),o=t.getHoles(),n=n||t.getCenter();var s,c=e.coordinateToVector3(n);s=r?new Float32Array(2*i.length):[];for(var h=0,u=i.length;h<u;h++){var l=e.coordinateToVector3(i[h]).sub(c);if(r){var f=2*h;s[f]=l.x,s[f+1]=l.y}else s.push([l.x,l.y])}var d=[r?s.buffer:s];if(o&&o.length>0)for(var v=0,p=o.length;v<p;v++){for(var g=r?new Float32Array(2*o[v].length):[],y=0,m=o[v].length;y<m;y++){var x=e.coordinateToVector3(o[v][y]).sub(c);if(r){var b=2*y;g[b]=x.x,g[b+1]=x.y}else g.push([x.x,x.y])}d.push(r?g.buffer:g)}return d}var oe={altitude:0,height:1,topColor:null,bottomColor:"#2d2f61"},ae=function(t){function e(e,n,o,a){var s;n=r.Util.extend({},oe,n,{layer:a,polygon:e}),(s=t.call(this)||this)._initOptions(n);var c=n.topColor,h=n.bottomColor,u=n.altitude,l=function(t,e,n,r){var o=te(t,e,n,void 0),a=o.position,s=o.normal,c=o.uv,h=o.indices,u=new Float32Array(a.length);u.fill(1,0,a.length);var l=new i.BufferGeometry;return f(l,"color",new i.BufferAttribute(u,3)),f(l,"normal",new i.BufferAttribute(s,3)),f(l,"position",new i.BufferAttribute(a,3)),f(l,"uv",new i.BufferAttribute(c,2)),l.setIndex(new i.Uint32BufferAttribute(h,1)),l}(e,n.height,a),d=Zt(e)?qt(e):e.getCenter();c&&!o.map&&(ee(l,h,c),o.vertexColors=i.VertexColors),s._createMesh(l,o);var v=a.distanceToVector3(u,u).x,p=a.coordinateToVector3(d,v);return s.getObject3d().position.copy(p),s}return c(e,t),e}(O),se={altitude:0,coordinate:null},ce=function(t){function e(e,n,i){var o;void 0===n&&(n={}),n.coordinate||(console.warn("coordinate is null,it is important to locate the model"),n.coordinate=i.getMap().getCenter()),n=r.Util.extend({},se,n,{layer:i,model:e}),(o=t.call(this)||this)._initOptions(n),o._createGroup(),o.getObject3d().add(e);var a=n.altitude,s=n.coordinate,c=i.distanceToVector3(a,a).x,h=i.coordinateToVector3(s,c);return o.getObject3d().position.copy(h),o}return c(e,t),e}(O),he=Math.PI/180;function ue(t){return t*he}function le(t,e){if(!t||!e)return 0;Array.isArray(t)||(t=t.toArray()),Array.isArray(e)||(e=e.toArray());var n=ue(t[1]),r=ue(e[1]),i=n-r,o=ue(t[0])-ue(e[0]);return n=2*Math.asin(Math.sqrt(Math.pow(Math.sin(i/2),2)+Math.cos(n)*Math.cos(r)*Math.pow(Math.sin(o/2),2))),n*=6378137,Math.round(1e5*n)/1e5}function fe(t,e){var n=t.c1,r=t.c2,i=e/t.len;return[n[0]+i*(r[0]-n[0]),n[1]+i*(r[1]-n[1])]}function de(t,e,n,r){var i=e.length;t.attributes.normal.count=i,t.attributes.position.count=i;for(var o=t.attributes.position.array,a=t.attributes.normal.array,s=0;s<i;s++)o[s]=e[s],a[s]=n[s];t.index.count=r.length;for(var c=0,h=r.length;c<h;c++)t.index.array[c]=r[c]}var ve,pe,ge={trail:5,chunkLength:50,width:2,height:1,speed:1,altitude:0,interactive:!1},ye=function(t){function e(e,n,o,a){var s;n=r.Util.extend({},ge,n,{layer:a,lineString:e}),(s=t.call(this)||this)._initOptions(n);var c,h,u=n.width,l=n.height,d=n.altitude,v=n.speed,p=n.chunkLength,g=n.trail;Ft(e)?(c=qt(e),h=Ht(e)):(c=e.getCenter(),h=e);for(var y=function(t,e){void 0===e&&(e=10),e=Math.max(e,1),Array.isArray(t)||(t=t.getCoordinates().map(function(t){return t.toArray()}));for(var n=t.length,r=[],i=0,o=0;o<n-1;o++){var a=le(t[o],t[o+1]),s=Math.floor(a);r.push({c1:t[o],len:s,c2:t[o+1]}),i+=s}if(i<=e)return r.map(function(t){return[t.c1,t.c2]});if(1===r.length&&r[0].len<=e)return[[r[0].c1,r[0].c2]];for(var c,h=r.length,u=0,l=0,f=[],d=[r[0].c1];u<h;){var v=r[u],p=v.len,g=v.c2;if((l+=p)<e&&(d.push(g),u===h-1&&f.push(d),u++),l===e&&(d.push(g),l=0,f.push(d),d=[g],u++),l>e){var y=p-l+e;c=fe(r[u],y),d.push(c),f.push(d),l=0,r[u].c1=c,r[u].len=p-y,(d=[]).push(c)}}return f}(h,p),m=a.coordinateToVector3(e.getCenter()),x={},b=0,_=y.length;b<_;b++)for(var w=y[b],M=0,O=w.length;M<O;M++){var j=w[M],S=j.join(",").toString();x[S]||(x[S]=a.coordinateToVector3(j).sub(m))}var C=Nt(y.slice(0,1),a,x,m).positionsV,A=new i.BufferGeometry,T=new Float32Array(3e3),P=new Float32Array(3e3),k=new Uint16Array(1e3);f(A,"position",new i.BufferAttribute(T,3)),f(A,"normal",new i.BufferAttribute(P,3)),A.setIndex(new i.BufferAttribute(k,1));var B=a.distanceToVector3(u,u).x,I=a.distanceToVector3(l,l).x,L=Qt(C,B,I,a);de(A,L.position,L.normal,L.indices),s._createMesh(A,o);var E=a.distanceToVector3(d,d).x,z=a.coordinateToVector3(c,E);return s.getObject3d().position.copy(z),s._params={index:0,chunkLines:y,geometries:[],layer:a,trail:Math.max(1,g),lineWidth:B,depth:I,speed:Math.min(1,v),idx:0,loaded:!1,positionMap:x,centerPt:m},s._init(s._params),s}c(e,t);var n=e.prototype;return n._init=function(t){for(var e=t.layer,n=t.trail,r=t.lineWidth,i=t.depth,o=t.chunkLines,a=t.positionMap,s=t.centerPt,c=o.length,h=[],u=0;u<c;u++){var l=Nt(o.slice(u,u+n),e,a,s).positionsV;h.push(Qt(l,r,i,e))}this._params.geometries=h,this._params.loaded=!0},n._animation=function(){var t=this._params,e=t.index,n=t.geometries,r=t.speed,i=t.idx,o=t.chunkLines,a=t.trail,s=t.lineWidth,c=t.depth,h=t.layer,u=t.positionMap,l=t.centerPt;if(t.loaded){var f=Math.round(e);if(f>i){this._params.idx++;var d=n[f];d||(d=Qt(Nt(o.slice(f,f+a),h,u,l).positionsV,s,c,h),n[f]=d),de(this.getObject3d().geometry,d.position,d.normal,d.indices),this.getObject3d().geometry.attributes.position.needsUpdate=!0,this.getObject3d().geometry.attributes.normal.needsUpdate=!0,this.getObject3d().geometry.index.needsUpdate=!0}e>=o.length-1&&(this._params.index=-1,this._params.idx=-1),this._params.index+=r}},e}(O),me=["click","mousemove","mousedown","mouseup","dblclick","contextmenu"].join(" ").toString(),xe=function(t){return function(t){function e(){return t.apply(this,arguments)||this}c(e,t);var n=e.prototype;return n._initBaseObjectsEvent=function(t){if(t&&Array.isArray(t)&&t.length)for(var e=0,n=t.length;e<n;e++)this._proxyEvent(t[e]);return this},n._proxyEvent=function(t){var e=this;t.on("add",function(t){e._showGeometry(t.target,!0)}),t.on("remove",function(t){e._showGeometry(t.target,!1)}),t.on("mouseout",function(t){e._mouseover=!1,e.fire("mouseout",Object.assign({},t,{target:e,selectMesh:e.getSelectMesh?e.getSelectMesh():null}))}),t.on(me,function(t){e.fire(t.type,Object.assign({},t,{target:e,selectMesh:e.getSelectMesh?e.getSelectMesh():null}))})},n._getHideGeometryIndex=function(t){for(var e=[],n=0,r=0,i=this._geometriesAttributes.length;r<i;r++)!0===this._geometriesAttributes[r].hide&&(e.push(r),n+=this._geometriesAttributes[r][t].count);return{indexs:e,count:n}},n._updateAttribute=function(t,e){for(var n=this._getHideGeometryIndex(e).indexs,r=this._geometryCache.attributes[e].array,o=r.length,a=0;a<o;a++)t.array[a]=r[a];var s=NaN;this.getObject3d()instanceof i.LineSegments&&(s=0);for(var c=0;c<n.length;c++)for(var h=this._geometriesAttributes[n[c]][e],u=h.end,l=h.start;l<u;l++)t.array[l]=s;return this},n._showGeometry=function(t,e){var n;if(t&&(n=t.getOptions().index),null!=n){var r=this._geometriesAttributes[n];if(r.hide===e)return this;r.hide=e;var i=this.getObject3d().geometry;this._updateAttribute(i.attributes.position,"position"),i.attributes.position.needsUpdate=!0,this.isHide=e}return this},n.getSelectMesh=function(){return{data:null,baseObject:null}},e}(t)};function be(){return r.worker||console.error("maptalks.worker is not defined,You can't use ThreeVectorTileLayer"),pe||(pe=new ve("maptalks.three")),pe}r.worker&&(ve=function(t){function e(){return t.apply(this,arguments)||this}c(e,t);var n=e.prototype;return n.test=function(t,e){this.send(t,null,e)},n.pushQueue=function(t){void 0===t&&(t={});var e,n=t.type,r=t.callback,i=t.key;"Polygon"===n&&(e=function(t,e,n){void 0===t&&(t=[]);for(var r=t.length,i=[],o=[],a={},s=0;s<r;s++){for(var c=t[s],h=re(c,n,e,!0),u=0,l=h.length;u<l;u++)for(var f=h[u],d=0,v=f.length;d<v;d++)o.push(f[d]);var p=(Zt(c)?c.properties:c.getProperties()||{}).height||1;null==a[p]&&(a[p]=n.distanceToVector3(p,p).x),i.push({data:h,height:p=a[p]})}return{datas:i,transfer:o}}(t.data,t.center,t.layer)),this.send({type:n,datas:e.datas},e.transfe,function(t,e){t&&console.error(t),e.key=i,r(e)})},e}(r.worker.Actor));var _e={altitude:0,height:1,topColor:null,bottomColor:"#2d2f61"},we=function(t){function e(e,n,o,a){var s;Array.isArray(e)||(e=[e]);var c=e.length;0===c&&console.error("polygons is empty");for(var u=1/0,l=1/0,d=-1/0,v=-1/0,p=0;p<c;p++){var g=e[p],y=g.getCenter?g.getCenter():qt(g),m=void 0,x=void 0;Array.isArray(y)?(m=y[0],x=y[1]):y instanceof r.Coordinate&&(m=y.x,x=y.y),u=Math.min(u,m),l=Math.min(l,x),d=Math.max(d,m),v=Math.max(v,x)}var b,_=new r.Coordinate((u+d)/2,(l+v)/2),w=(n=r.Util.extend({},_e,n,{layer:a,polygons:e,coordinate:_})).topColor,M=n.bottomColor,O=n.altitude,S=[],C=[],A=[];if(n.asynchronous){var T=be(),P=1e-6;b=new i.BoxBufferGeometry(P,P,5*P),T.pushQueue({type:"Polygon",layer:a,key:n.key,center:_,data:e,callback:function(t){var e=t.geometriesAttributes;s._faceMap=t.faceMap,s._geometriesAttributes=e;var n=function(t){var e=t.position,n=t.normal,r=t.uv,o=t.indices,a=new Float32Array(e.length);a.fill(1,0,e.length);var s=new i.BufferGeometry;return f(s,"color",new i.BufferAttribute(a,3)),f(s,"normal",new i.BufferAttribute(new Float32Array(n),3)),f(s,"position",new i.BufferAttribute(new Float32Array(e),3)),f(s,"uv",new i.BufferAttribute(new Float32Array(r),2)),s.setIndex(new i.BufferAttribute(new Uint32Array(o),1)),s}(t);w&&!o.map&&(ee(n,M,w),o.vertexColors=i.VertexColors),s.getObject3d().geometry.dispose(),s.getObject3d().geometry=n,s.getObject3d().material.needsUpdate=!0,s._geometryCache=n.clone(),s._fire("workerload",{target:h(s)})}})}else{for(var k=[],B=0,I=0,L=0,E=0,z={},V=0;V<c;V++){var R=e[V],U=(Zt(R)?R.properties:R.getProperties()||{}).height||1,F=te(R,U,a,_,z);k.push(F);var Z=F.position,G=F.normal,D=F.uv,H=F.indices.length/3;C[V]=[B+1,B+H],B+=H;var q=Z.length/3,W=G.length/3,K=D.length/2;A[V]={position:{count:q,start:I,end:I+3*q},normal:{count:W,start:L,end:L+3*W},uv:{count:K,start:E,end:E+2*K},hide:!1},I+=3*q,L+=3*W,E+=2*K}b=j(k),w&&!o.map&&(ee(b,M,w),o.vertexColors=i.VertexColors)}(s=t.call(this)||this)._initOptions(n),s._createMesh(b,o);var N=a.distanceToVector3(O,O).x,Q=a.coordinateToVector3(_,N);return s.getObject3d().position.copy(Q),s._faceMap=C,s._baseObjects=S,s._datas=e,s._geometriesAttributes=A,s.faceIndex=null,s._geometryCache=b.clone(),s.isHide=!1,s._initBaseObjectsEvent(S),s}c(e,t);var n=e.prototype;return n.getSelectMesh=function(){var t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){var e=this._datas[t],n=Object.assign({},this.options,Zt(e)?e.properties:e.getProperties(),{index:t});this._baseObjects[t]=new ae(e,n,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}},n._getIndex=function(t){if(null==t&&(t=this.faceIndex),null!=t)for(var e=0,n=this._faceMap.length;e<n;e++){var r=this._faceMap[e];if(r[0]<=t&&t<r[1])return e}},e}(xe(O));function Me(t,e,n){var r=t.project(n),i=e.width/2,o=e.height/2;return{x:Math.round(r.x*i+i),y:Math.round(-r.y*o+o)}}var Oe={altitude:0,height:0},je=new i.Vector3,Se=function(t){function e(e,n,o,a){var s;n=r.Util.extend({},Oe,n,{layer:a,coordinate:e}),s=t.call(this)||this;var c=n.height,h=n.altitude,u=n.color,l=[],d=[];u&&(u=u instanceof i.Color?u:new i.Color(u),d.push(u.r,u.g,u.b));var v=a.distanceToVector3(c,c).x,p=a.coordinateToVector3(e,v);l.push(0,0,p.z);var g=new i.BufferGeometry;f(g,"position",new i.Float32BufferAttribute(l,3,!0)),d.length&&f(g,"color",new i.Float32BufferAttribute(d,3,!0)),n.positions=p,s._initOptions(n),s._createPoints(g,o);var y=a.distanceToVector3(h,h).x,m=new i.Vector3(p.x,p.y,y);return s.getObject3d().position.copy(m),s}return c(e,t),e.prototype.identify=function(t){var e=this.getLayer(),n=this.getMap().getSize(),r=this.getLayer().getCamera(),i=this.getOptions().positions,o=this.getOptions().altitude,a=this.getObject3d().material.size,s=this.getMap().coordToContainerPoint(t),c=e.distanceToVector3(o,o).x;je.x=i.x,je.y=i.y,je.z=i.z+c;var h=Me(je,n,r);return Math.sqrt(Math.pow(s.x-h.x,2)+Math.pow(s.y-h.y,2))<=a/2},e}(O);function Ce(t,e){var n=e[0],r=e[1];return t.minx<=n&&n<=t.maxx&&t.miny<=r&&r<=t.maxy}var Ae=function(){function t(t,e,n,r){this.minlng=t,this.minlat=e,this.maxlng=n,this.maxlat=r,this.minx=1/0,this.miny=1/0,this.maxx=-1/0,this.maxy=-1/0,this.coordinates=[],this.positions=[],this.indexs=[],this.key=null}var e=t.prototype;return e.updateBBoxPixel=function(t){var e=1/0,n=1/0,i=-1/0,o=-1/0,a=this.minlng,s=this.minlat,c=this.maxlng,h=this.maxlat;return[[a,s],[a,h],[c,s],[c,h]].map(function(t){return new r.Coordinate(t)}).map(function(e){return t.coordToContainerPoint(e)}).forEach(function(t){e=Math.min(e,t.x),n=Math.min(n,t.y),i=Math.max(i,t.x),o=Math.max(o,t.y)}),this.minx=e,this.miny=n,this.maxx=i,this.maxy=o,this},e.containsCoordinate=function(t){var e,n;return Array.isArray(t)?(e=t[0],n=t[1]):t instanceof r.Coordinate&&(e=t.x,n=t.y),!!(this.minlng<=e&&e<=this.maxlng&&this.minlat<=n&n<=this.maxlat)},e.isRecCross=function(t,e){var n=t.x,r=t.y,i={minx:n-e/2,miny:r-e/2,maxx:n+e/2,maxy:r+e/2},o=i.minx,a=i.miny,s=i.maxx,c=i.maxy;return!!(Ce(this,[o,a])||Ce(this,[o,c])||Ce(this,[s,a])||Ce(this,[s,c])||Ce(i,[this.minx,this.miny])||Ce(i,[this.minx,this.maxy])||Ce(i,this.maxx)||Ce(i,this.maxx))},t.initGrids=function(e,n,r,i){for(var o=[],a=(r-e)/30,s=(i-n)/30,c=e,h=n,u=0;u<30;u++){c=e+u*a;for(var l=0;l<30;l++){var f=new t(c,h=n+l*s,c+a,h+s);f.key=l+"-"+u,o.push(f)}}return o},t}(),Te={altitude:0},Pe=new i.Vector3,ke=function(t){function e(e,n,o,a){var s;Array.isArray(e)||(e=[e]),n=r.Util.extend({},Te,n,{layer:a,points:e});for(var c=1/0,h=1/0,u=-1/0,l=-1/0,d=0,v=e.length;d<v;d++){var p=e[d].coordinate,g=void 0,y=void 0;Array.isArray(p)?(g=p[0],y=p[1]):p instanceof r.Coordinate&&(g=p.x,y=p.y),c=Math.min(c,g),h=Math.min(h,y),u=Math.max(u,g),l=Math.max(l,y)}for(var m=a.coordinateToVector3([(c+u)/2,(h+l)/2]),x=Ae.initGrids(c,h,u,l),b=x.length,_=[],w=[],M=[],O=[],j=[],S=0,C=e.length;S<C;S++){var A=e[S],T=A.coordinate,P=A.height,k=A.color;k&&(k=k instanceof i.Color?k:new i.Color(k),M.push(k.r,k.g,k.b));var B=a.distanceToVector3(P,P).x,I=a.coordinateToVector3(T,B),L=I.clone().sub(m);_.push(L.x,L.y,L.z),w.push(I),j[S]={position:{count:1,start:3*S,end:3*S+3},hide:!1};for(var E=0;E<b;E++)if(x[E].containsCoordinate(T)){x[E].positions.push(I),x[E].indexs.push(S);break}}var z=new i.BufferGeometry;f(z,"position",new i.Float32BufferAttribute(_,3,!0)),M.length&&f(z,"color",new i.Float32BufferAttribute(M,3,!0)),n.positions=w,(s=t.call(this)||this)._initOptions(n),s._createPoints(z,o);var V=n.altitude,R=a.distanceToVector3(V,V).x,U=m.clone();return U.z=R,s.getObject3d().position.copy(U),s._baseObjects=O,s._datas=e,s.faceIndex=null,s._geometriesAttributes=j,s._geometryCache=z.clone(),s.isHide=!1,s._initBaseObjectsEvent(O),s._grids=x,s._bindMapEvents(),s}c(e,t);var n=e.prototype;return n._bindMapEvents=function(){var t=this,e=this.getMap();this.on("add",function(){t._updateGrids(),e.on("zoomstart zooming zoomend movestart moving moveend pitch rotate",t._updateGrids,t)}),this.on("remove",function(){e.off("zoomstart zooming zoomend movestart moving moveend pitch rotate",t._updateGrids,t)})},n._updateGrids=function(){var t=this.getMap();this._grids.forEach(function(e){e.indexs.length&&e.updateBBoxPixel(t)})},n.getSelectMesh=function(){var t=this.faceIndex;if(null!=t){if(!this._baseObjects[t]){var e=this._datas[t];this._baseObjects[t]=new Se(e.coordinate,{height:e.height,index:t,color:e.color},this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}},n.identify=function(t){var e=this.getLayer(),n=this.getMap().getSize(),r=this.getLayer().getCamera(),i=this.getOptions().altitude,o=this.getMap(),a=e.distanceToVector3(i,i).x,s=this.getObject3d().material.size,c=o.coordToContainerPoint(t),h=[];if(this._grids.forEach(function(t){t.indexs.length&&t.isRecCross(c,s)&&h.push(t)}),h.length<1)return!1;for(var u=0,l=h.length;u<l;u++)for(var f=0,d=h[u].positions.length;f<d;f++){var v=h[u].positions[f];Pe.x=v.x,Pe.y=v.y,Pe.z=v.z+a;var p=Me(Pe,n,r);if(Math.sqrt(Math.pow(c.x-p.x,2)+Math.pow(c.y-p.y,2))<=s/2)return this.faceIndex=h[u].indexs[f],!0}return!1},e}(xe(O)),Be={coordinate:null,radius:10,height:100,radialSegments:6,altitude:0,topColor:null,bottomColor:"#2d2f61"},Ie=function(t){function e(e,n,o,a){var s;Array.isArray(e)||(e=[e]);for(var c=e.length,h=[],u=[],l=[],f=[],d=0,v=0,p=0,g=0,y=0;y<c;y++){var m=r.Util.extend({index:y},Be,e[y]),x=m.radius,b=m.radialSegments,_=m.altitude,w=m.topColor,M=m.bottomColor,O=m.height,S=m.coordinate,C=a.distanceToVector3(x,x).x,P=a.distanceToVector3(O,O).x,B=a.distanceToVector3(_,_).x,I=A({radius:C,height:P,radialSegments:b},!1);w&&!o.map&&(T(I,M,w,"z",P/2),o.vertexColors=i.VertexColors);for(var L=a.coordinateToVector3(S),E=I.attributes.position.array,z=0,V=E.length;z<V;z+=3)E[z+2]+=B,E[z]+=L.x,E[z+1]+=L.y,E[z+2]+=L.z;h.push(I);var R=new k(S,m,o,a);u.push(R);var U=I.index.count/3;f[y]=[d+1,d+U],d+=U;var F=I.attributes.position.count,Z=I.attributes.normal.count,G=I.attributes.uv.count;l[y]={position:{count:F,start:v,end:v+3*F},normal:{count:Z,start:p,end:p+3*Z},uv:{count:G,start:g,end:g+2*G},hide:!1},v+=3*F,p+=3*Z,g+=2*G}s=t.call(this)||this,n=r.Util.extend({},{altitude:0,layer:a,points:e},n),s._initOptions(n);var D=function(t){for(var e=[],n=[],r=0,i=t.length;r<i;r++){var o=t[r].attributes,a=o.color,s=o.normal,c=o.position,h=o.uv,u=t[r].index;if(a)for(var l=0,f=a.array.length;l<f;l++)n.push(a.array[l]);e.push({normal:s.array,uv:h.array,position:c.array,indices:u.array})}var d=j(e);if(n.length)for(var v=0,p=n.length;v<p;v++)d.attributes.color.array[v]=n[v];return d}(h);return s._createMesh(D,o),s._faceMap=f,s._baseObjects=u,s._datas=e,s._geometriesAttributes=l,s.faceIndex=null,s._geometryCache=D.clone(),s.isHide=!1,s._colorMap={},s._initBaseObjectsEvent(u),s._setPickObject3d(),s._init(),s}c(e,t);var n=e.prototype;return n.getSelectMesh=function(){var t=this._getIndex();if(null!=t)return{data:this._datas[t],baseObject:this._baseObjects[t]}},n._getIndex=function(t){return null==t&&(t=this.faceIndex||this.index),t},n._init=function(){var t=this,e=this.getLayer().getPick();this.on("add",function(){e.add(t.pickObject3d)}),this.on("remove",function(){e.remove(t.pickObject3d)})},n._setPickObject3d=function(){for(var t=this.getObject3d().geometry.clone(),e=this.getLayer().getPick(),n=this._geometriesAttributes,r=[],o=0,a=n.length;o<a;o++){var s=e.getColor(),c=s.getHex();this._colorMap[c]=o;var h=n[o].position.count;this._datas[o].colorIndex=c;for(var u=0;u<h;u++)r.push(s.r,s.g,s.b)}f(t,"color",new i.Float32BufferAttribute(r,3,!0));var l=new i.MeshBasicMaterial;l.vertexColors=i.VertexColors;var d=e.getColor().getHex(),v=new i.Mesh(t,l);v.position.copy(this.getObject3d().position),v._colorIndex=d,this.setPickObject3d(v)},n.identify=function(t){return this.picked},e}(xe(O)),Le={width:3,height:1,altitude:0},Ee=function(t){function e(e,n,i,o){var a;Array.isArray(e)||(e=[e]);for(var s=[],c=e.length,h=0;h<c;h++){var u=e[h];s.push(Ft(u)?qt(u):u.getCenter())}for(var l=ne(s),f=[],d=[],v=0,p=[],g=[],y=0,m=0,x=0;x<c;x++){var b=e[x],_=r.Util.extend({},Le,Ft(b)?b.properties:b.getProperties(),{index:x}),w=_.height,M=_.width,O=Qt(b,o.distanceToVector3(M,M).x,o.distanceToVector3(w,w).x,o,l);f.push(O);var S=new $t(b,_,i,o);d.push(S);var C=O.position,A=O.normal,T=O.indices.length/3;p[x]=[v+1,v+T],v+=T;var P=C.length/3,k=A.length/3;g[x]={position:{count:P,start:y,end:y+3*P},normal:{count:k,start:m,end:m+3*k},hide:!1},y+=3*P,m+=3*k}var B=j(f);n=r.Util.extend({},Le,n,{layer:o,lineStrings:e,coordinate:l}),(a=t.call(this)||this)._initOptions(n),a._createMesh(B,i);var I=n.altitude,L=o.distanceToVector3(I,I).x,E=o.coordinateToVector3(l,L);return a.getObject3d().position.copy(E),a._faceMap=p,a._baseObjects=d,a._datas=e,a._geometriesAttributes=g,a.faceIndex=null,a._geometryCache=B.clone(),a.isHide=!1,a._colorMap={},a._initBaseObjectsEvent(d),a._setPickObject3d(),a._init(),a}c(e,t);var n=e.prototype;return n.getSelectMesh=function(){var t=this._getIndex();if(null!=t)return{data:this._datas[t],baseObject:this._baseObjects[t]}},n._getIndex=function(t){return null==t&&(t=this.faceIndex||this.index),t},n._init=function(){var t=this,e=this.getLayer().getPick();this.on("add",function(){e.add(t.pickObject3d)}),this.on("remove",function(){e.remove(t.pickObject3d)})},n._setPickObject3d=function(){for(var t=this.getObject3d().geometry.clone(),e=this.getLayer().getPick(),n=this._geometriesAttributes,r=[],o=0,a=n.length;o<a;o++){var s=e.getColor(),c=s.getHex();this._colorMap[c]=o;var h=n[o].position.count;this._datas[o].colorIndex=c;for(var u=0;u<h;u++)r.push(s.r,s.g,s.b)}f(t,"color",new i.Float32BufferAttribute(r,3,!0));var l=new i.MeshBasicMaterial;l.vertexColors=i.VertexColors;var d=e.getColor().getHex(),v=new i.Mesh(t,l);v.position.copy(this.getObject3d().position),v._colorIndex=d,this.setPickObject3d(v)},n.identify=function(t){return this.picked},e}(xe(O)),ze={altitude:0,colors:null},Ve=function(t){function e(e,n,o,a){var s;Array.isArray(e)||(e=[e]);for(var c=[],h=e.length,u=0;u<h;u++){var l=e[u];c.push(Gt(l)?qt(l):l.getCenter())}var d=ne(c);n=r.Util.extend({},ze,n,{layer:a,lineStrings:e,coordinate:d});for(var v=[],p=0,g=[],y=[],m=0,x=[],b=0;b<h;b++){for(var _=Kt(e[b],a,d).positionsV,w=0,M=_.length;w<M;w++){var O=_[w];w>0&&w<M-1&&x.push(O.x,O.y,O.z),x.push(O.x,O.y,O.z)}var j=_.length+_.length-2,S=j;g[b]=[p,p+S],p+=S,y[b]={position:{count:j,start:m,end:m+3*j},hide:!1},m+=3*j}var C=new i.BufferGeometry;f(C,"position",new i.Float32BufferAttribute(x,3)),(s=t.call(this)||this)._initOptions(n),s._createLineSegments(C,o);var A=n.altitude,T=a.distanceToVector3(A,A).x,P=a.coordinateToVector3(d,T);return s.getObject3d().position.copy(P),s._faceMap=g,s._baseObjects=v,s._datas=e,s._geometriesAttributes=y,s.faceIndex=null,s.index=null,s._geometryCache=C.clone(),s.isHide=!1,s._colorMap={},s._initBaseObjectsEvent(v),s._setPickObject3d(),s._init(),s}c(e,t);var n=e.prototype;return n.getSelectMesh=function(){var t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){var e=this._datas[t],n=r.Util.extend({},this.getOptions(),{index:t},Gt(e)?e.properties:e.getProperties());this._baseObjects[t]=new Jt(e,n,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}},n._getIndex=function(t){return null==t&&(t=this.faceIndex||this.index),t},n._init=function(){var t=this,e=this.getLayer().getPick();this.on("add",function(){e.add(t.pickObject3d)}),this.on("remove",function(){e.remove(t.pickObject3d)})},n._setPickObject3d=function(){for(var t=this.getObject3d().geometry.clone(),e=this.getLayer().getPick(),n=this._geometriesAttributes,r=[],o=0,a=n.length;o<a;o++){var s=e.getColor(),c=s.getHex();this._colorMap[c]=o;var h=n[o].position.count;this._datas[o].colorIndex=c;for(var u=0;u<h;u++)r.push(s.r,s.g,s.b)}f(t,"color",new i.Float32BufferAttribute(r,3,!0));var l=this.getObject3d().material.clone();l.color.set("#fff"),l.vertexColors=i.VertexColors;var d=e.getColor().getHex(),v=new i.LineSegments(t,l);v.position.copy(this.getObject3d().position),v._colorIndex=d,this.setPickObject3d(v)},n.identify=function(t){return this.picked},e}(xe(O)),Re=[],Ue=[];function Fe(t,e){for(var n=0,r=t.length;n<r;n++){var i=t[n];if(i){var o=i.callback;if(e===i.key)return t.splice(n,1),o}}return null}var Ze=document.createElement("canvas"),Ge=256;function De(t,e){var n=Ze.getContext("2d");if(n.clearRect(0,0,Ge,Ge),n.save(),e){n.fillStyle="red",n.strokeStyle="rgba(255,0,0,0.4)",n.lineWidth=.2;var r=t||"tile";n.font="18px sans-serif",n.rect(0,0,Ge,Ge),n.stroke(),n.fillText(r,15,128)}return Ze.toDataURL()}function He(t,e){var n;return void 0===t&&(t=1),void 0===e&&(e=1),"undefined"==typeof document||(n=document.createElement("canvas"),t&&(n.width=t),e&&(n.height=e)),n}Ze.width=Ze.height=Ge;var qe=function(t){function e(e,n){var i;return void 0===n&&(n={}),(i=t.call(this,r.Util.GUID(),r.Util.extend({urlTemplate:e},n))||this)._opts=null,i._layer=null,i.material=null,i.getMaterial=null,i._baseObjectKeys={},i._loadTiles={},i._add=null,i._layerLaodTime=(new Date).getTime(),i}c(e,t);var n=e.prototype;return n.isAsynchronous=function(){return this._opts.worker},n.getBaseObjects=function(){var t=this._loadTiles,e=[];for(var n in t){var r=this._baseObjectKeys[n];if(r&&Array.isArray(r)&&r.length)for(var i=0,o=r.length;i<o;i++)e.push(r[i])}return e},n.onSelectMesh=function(t,e){},n.formatBaseObjects=function(t,e){},n.loopMessage=function(t){},n.getTileData=function(t){var e=t.key,n=t.callback,i=t.img;r.Ajax.getJSON(t.url,{},function(t,r){t?(console.error(t),n(e,null,i)):n(e,r,i)})},n._getCurentTileKeys=function(){for(var t=this.getTiles().tileGrids||[],e=[],n={},r=0,i=t.length;r<i;r++)for(var o=t[r].tiles||[],a=0,s=o.length;a<s;a++){var c=o[a].dupKey;e.push(c),n[c]=!0}return{keys:e,keysMap:n}},n._isLoad=function(){var t=this._getCurentTileKeys().keys,e=Object.keys(this._renderer.tilesInView);return t.length===e.length},n._layerOnLoad=function(){var t=(new Date).getTime();if(!(t-this._layerLaodTime<20)){this._layerLaodTime=t;var e=this._renderer.tilesInView,n=this._loadTiles,r=this._layer,i=this._baseObjectKeys,o=Object.keys(e).length,a=Object.keys(n).length,s=[];if(o&&a)for(var c in n)e[c]||i[c]&&(i[c]||[]).forEach(function(t){s.push(t)});if(s.length&&r.removeMesh(s,!1),o&&a)for(var h in e)if(!n[h])if(i[h])r.addMesh(i[h]);else{var u=this._getXYZOfIndex(h);this.getTileUrl(u.x,u.y,u.z)}this._loadTiles=Object.assign({},e),this._diffCache()}},n._init=function(){},n._workerLoad=function(t){var e=t.target._img;e.currentCount++,e.currentCount===e.needCount&&(e.src=De(e._key,this._opts.debug))},n._generateBaseObjects=function(t,e,n){var r=this;if(e&&n){if(!this._getCurentTileKeys().keysMap[t])return void(n.src=De(t,this._opts.debug));var i=this.formatBaseObjects(t,e);if(i.length){n.needCount=i.length,n.currentCount=0;for(var o=0,a=i.length;o<a;o++){var s=i[o];s._img=n,s._vt=this,this.isVisible()||s.hide(),this._cachetile(t,s),s.isAsynchronous()||n.currentCount++}this._layer.addMesh(i,!1),n.needCount===n.currentCount&&(n.src=De(t,this._opts.debug)),this.isAsynchronous()?i.filter(function(t){return t.isAsynchronous()}).forEach(function(t){t.on("workerload",r._workerLoad,r)}):n.src=De(t,this._opts.debug)}else n.src=De(t,this._opts.debug);this._loadTiles[t]=!0}else n&&(n.src=De(t,this._opts.debug))},n._diffCache=function(){var t=this;Object.keys(this._baseObjectKeys).length>this._renderer.tileCache.max&&function(){var e=t._renderer.tileCache.data,n=t._renderer.tilesInView,r=[];for(var i in t._baseObjectKeys)e[i]||n[i]||((t._baseObjectKeys[i]||[]).forEach(function(t){t.isAdd&&r.push(t)}),t._diposeBaseObject(i),delete t._baseObjectKeys[i]);r.length&&t._layer.removeMesh(r,!1)}()},n._diposeBaseObject=function(t){var e=this._baseObjectKeys[t];e&&e.length&&e.forEach(function(t){t.getObject3d().geometry.dispose(),t._geometryCache&&t._geometryCache.dispose();var e=t._baseObjects;e&&e.length&&e.forEach(function(t){t.getObject3d().geometry.dispose(),t=null}),t._datas=null,t._geometriesAttributes=null,t._faceMap=null,t=null})},n._cachetile=function(t,e){this._baseObjectKeys[t]||(this._baseObjectKeys[t]=[]),this._baseObjectKeys[t].push(e)},n._getXYZOfIndex=function(t){var e=t.indexOf("_")>-1?"_":"-",n=t.split(e).slice(1,4),r=n[0],i=n[1],o=n[2];return{x:i=parseInt(i),y:r=parseInt(r),z:o=parseInt(o)}},n._getTileExtent=function(t,e,n){var r=this.getMap()._getResolution(n);return this._getTileConfig().getTilePrjExtent(t,e,r)},n._getTileLngLatExtent=function(t,e,n){var i=this._getTileExtent(t,e,n),o=i.getMax(),a=i.getMin(),s=this.getMap().getProjection();return a=s.unproject(a),o=s.unproject(o),new r.Extent(a,o)},e}(r.TileLayer),We={worker:!1},Ke=function(t){function e(e,n,i,o){var a;return void 0===n&&(n={}),(a=t.call(this,r.Util.GUID(),r.Util.extend({urlTemplate:e},We,n))||this)._opts=n,a._layer=o,a.getMaterial=i,a._baseObjectKeys={},a._loadTiles={},a._add=null,a._layerLaodTime=(new Date).getTime(),a._init(),a}c(e,t);var n=e.prototype;return n.formatBaseObjects=function(t,e){var n=this._opts,o=[],a=this.isAsynchronous();for(var s in e){var c=e[s]||{},h=void 0;if(Array.isArray(c)?h=c:"FeatureCollection"===c.type&&(h=c.features),h&&h.length){for(var u=[],l=[],f=[],d=0,v=h.length;d<v;d++){var p=h[d];if(Zt(p))u.push(p);else if(Gt(p))for(var g=Wt(p),y=0,m=g.length;y<m;y++)l.push(g[y]);else if(Dt(p))for(var x=Wt(p),b=0,_=x.length;b<_;b++)f.push(r.Util.extend({},x[b].properties,x[b],{coordinate:Ht(x[b])}))}if(u.length){var w=this._getMaterial(s,u,t,c);if(w){var M=this._layer.toExtrudePolygons(u,r.Util.extend({},{topColor:"#fff",layerName:s,asynchronous:a,key:t},n),w);o.push(M)}}if(l.length){var O=this._getMaterial(s,l,t,c);if(O&&(O instanceof i.LineBasicMaterial||O instanceof i.LineDashedMaterial)){var j=this._layer.toLines(l,r.Util.extend({},{layerName:s},n),O);o.push(j)}}if(f.length){var S=this._getMaterial(s,f,t,c);if(S&&S instanceof i.PointsMaterial){var C=this._layer.toPoints(f,r.Util.extend({},{layerName:s},n),S);o.push(C)}}}}return o},n.loopMessage=function(t){({waitingQueue:Re,currentQueue:Ue}).currentQueue.length>0&&this.getTileData(t)},n._init=function(){var t=this;this.on("layerload",this._layerOnLoad),this.on("add",function(){if(!1===t._add){var e=t.getBaseObjects();t._layer.addMesh(e)}t._add=!0,t.intervalId=setInterval(function(){t._isLoad()&&!t._layer.getMap().isInteracting()&&t.fire("layerload")},1e3)}),this.on("remove",function(){t._add=!1;var e=t.getBaseObjects();t._layer.removeMesh(e),clearInterval(t.intervalId)}),this.on("show",function(){var e=t.getBaseObjects();for(var n in e.forEach(function(t){t.show()}),t._baseObjectKeys)(t._baseObjectKeys[n]||[]).forEach(function(t){t.show()})}),this.on("hide",function(){var e=t.getBaseObjects();for(var n in e.forEach(function(t){t.hide()}),t._baseObjectKeys)(t._baseObjectKeys[n]||[]).forEach(function(t){t.hide()})}),this.on("renderercreate",function(e){e.renderer.loadTile=function(t){var e=this.layer.getTileSize(),n=new Image;return n.width=e.width,n.height=e.height,n.onload=this.onTileLoad.bind(this,n,t),n.onerror=this.onTileError.bind(this,n,t),this.loadTileImage(n,t.url,t.dupKey),n},e.renderer.deleteTile=function(t){var e,n;t&&t.image&&(t.image.onload=null,t.image.onerror=null,(n=Fe(Re,e=(t.info||{}).dupKey))&&n(e))},e.renderer.loadTileImage=function(e,n,r){e._key=r,function(e,n,r,i,o){var a={key:e,url:n,callback:function(e,n,r){t._generateBaseObjects(e,n,r),function(t,e){Fe(Ue,t),Re.length&&(Ue.push(Re[0]),Re.splice(0,1),e.loopMessage(Ue[Ue.length-1]))}(e,t)},img:i,vt:o};Ue.length<10?(Ue.push(a),o.loopMessage(a)):Re.push(a)}(r,n,0,e,t)}})},n._getMaterial=function(t,e,n,i){return this.getMaterial&&r.Util.isFunction(this.getMaterial)?this.getMaterial(t,e,n,i):null},e}(qe),Ne=new i.TextureLoader,Qe=document.createElement("canvas");function Xe(t){return t?("string"==typeof t?(e=new Image).src=t:t instanceof HTMLCanvasElement?(e=new Image).src=t.toDataURL():t instanceof Image&&((e=new Image).src=t.src,e.crossOrigin=t.crossOrigin),e&&!e.crossOrigin&&(e.crossOrigin="Anonymous"),e):null;var e}var Je={interactive:!1,altitude:0,image:null,imageWidth:256,imageHeight:256,texture:null},Ye=function(t){function e(e,n,o,a){var s,c=(n=r.Util.extend({},Je,n,{layer:a,extent:e})).texture,h=n.image,u=n.altitude,l=n.imageHeight,f=n.imageWidth;h||console.error("not find image"),e instanceof r.Extent||(e=new r.Extent(e));var d=e.xmin,v=e.ymin,p=e.xmax,g=e.ymax,y=1/0,m=1/0,x=-1/0,b=-1/0;[[d,v],[d,g],[p,g],[p,v]].forEach(function(t){var e=a.coordinateToVector3(t),n=e.x,r=e.y;y=Math.min(n,y),m=Math.min(r,m),x=Math.max(n,x),b=Math.max(r,b)});var _=Math.abs(x-y),w=Math.abs(b-m),M=Xe(h),O=Xe(c),j=new i.PlaneBufferGeometry(_,w,f-1,l-1);(s=t.call(this)||this)._initOptions(n),s._createMesh(j,o);var S=a.distanceToVector3(u,u).x,C=a.coordinateToVector3(e.getCenter(),S);return s.getObject3d().position.copy(C),o.transparent=!0,M&&(o.opacity=0,M.onload=function(){for(var t=function(t,e,n){void 0===e&&(e=256),void 0===n&&(n=256),Qe.width=e,Qe.height=n;var r=Qe.getContext("2d");return r.drawImage(t,0,0,e,n),r.getImageData(0,0,e,n).data}(M,f,l),e=0,n=0,r=t.length;n<r;n+=4){var i=.1*(256*t[n]*256+256*t[n+1]+t[n+2])-1e4,s=a.distanceToVector3(i,i).x;j.attributes.position.array[3*e+2]=s,e++}j.attributes.position.needsUpdate=!0,O?Ne.load(O.src,function(t){o.map=t,o.opacity=1,o.needsUpdate=!0}):o.opacity=1},M.onerror=function(){console.error("not load "+M.src)}),s}return c(e,t),e}(O),$e={scale:1},tn=function(t){function e(e,n,i,o){var a;return void 0===n&&(n={}),(a=t.call(this,r.Util.GUID(),r.Util.extend({urlTemplate:e},$e,n))||this)._opts=n,a._layer=o,a.material=i,a._baseObjectKeys={},a._loadTiles={},a._add=null,a._imgQueue={},a._layerLaodTime=(new Date).getTime(),a._init(),a}c(e,t);var n=e.prototype;return n.isAsynchronous=function(){return!1},n.formatBaseObjects=function(t,e){var n=[],r=this.options.scale,i=this._getXYZOfIndex(t),o=i.x,a=i.y,s=i.z,c=this.getMap().getZoom(),h=this.getTileUrl(o,a,s),u=this.options.tileSize,l=u[0],f=u[1],d=this._getTileLngLatExtent(o,a,s),v=this.material.clone();if(s+1>=Math.round(c)){var p=new Ye(d,{image:e,imageWidth:l/8,imageHeight:f/8,texture:h},v,this._layer);p.getObject3d().scale.set(r,r,1),n.push(p)}return n},n.loopMessage=function(t){this.getTileData(t)},n._init=function(){var t=this;this.on("layerload",this._layerOnLoad),this.on("add",function(){if(!1===t._add){var e=t.getBaseObjects();t._layer.addMesh(e)}t._add=!0,t.intervalId=setInterval(function(){t._isLoad()&&!t._layer.getMap().isInteracting()&&t.fire("layerload")},1e3)}),this.on("remove",function(){t._add=!1;var e=t.getBaseObjects();t._layer.removeMesh(e),clearInterval(t.intervalId)}),this.on("show",function(){var e=t.getBaseObjects();for(var n in e.forEach(function(t){t.show()}),t._baseObjectKeys)(t._baseObjectKeys[n]||[]).forEach(function(t){t.show()})}),this.on("hide",function(){var e=t.getBaseObjects();for(var n in e.forEach(function(t){t.hide()}),t._baseObjectKeys)(t._baseObjectKeys[n]||[]).forEach(function(t){t.hide()})}),this.on("renderercreate",function(e){e.renderer.loadTile=function(t){var e=this.layer.getTileSize(),n=new Image;return n.width=e.width,n.height=e.height,n.onload=this.onTileLoad.bind(this,n,t),n.onerror=this.onTileError.bind(this,n,t),this.loadTileImage(n,t.url,t.dupKey),n},e.renderer.deleteTile=function(e){if(e&&e.image){e.image.onload=null,e.image.onerror=null;var n=e.info||{},r=t._imgQueue[n.dupKey];r&&(r.src="",r.onload=null,r.onerror=null,delete t._imgQueue[n.dupKey])}},e.renderer.loadTileImage=function(e,n,r){e._key=r;var i=new Image;t._imgQueue[r]=i;var o={key:r,url:n,rgbImage:i,callback:function(e,n,r){t._generateBaseObjects(e,n,r)},img:e,vt:t};t.loopMessage(o)}})},e}(qe);
/*!
   * Code from baidu mapv
   * License: BSD-3
   * https://github.com/huiyan-fe/mapv
   *
   */
function en(t){this.gradient=(t=t||{}).gradient||{.25:"rgba(0, 0, 255, 1)",.55:"rgba(0, 255, 0, 1)",.85:"rgba(255, 255, 0, 1)",1:"rgba(255, 0, 0, 1)"},this.maxSize=t.maxSize||35,this.minSize=t.minSize||0,this.max=t.max||100,this.min=t.min||0,this.initPalette()}function nn(t,e,n){var r=rn(n),i=function(t){return t.min||0}(n),o=r-i,a=n.range||null,s=0,c=1024;a&&2===a.length&&(s=(a[0]-i)/o*1024),a&&2===a.length&&(c=(a[1]-i)/o*1024);for(var h,u=n.maxOpacity||.8,l=n.minOpacity||0,f=3,d=t.length;f<d;f+=4)h=4*t[f],t[f]/256>u&&(t[f]=256*u),t[f]/256<l&&(t[f]=256*l),h&&h>=s&&h<=c?(t[f-3]=e[h],t[f-2]=e[h+1],t[f-1]=e[h+2]):t[f]=0}function rn(t){return t.max||100}function on(t,e,n){var r=rn(n),i=
/*!
   * Code from baidu mapv
   * License: BSD-3
   * https://github.com/huiyan-fe/mapv
   *
   */
function(t){var e=t/2,n=t+e,r=1e4,i=new He(2*n,2*n),o=i.getContext("2d");return o.shadowBlur=e,o.shadowColor="black",o.shadowOffsetX=o.shadowOffsetY=r,o.beginPath(),o.arc(n-r,n-r,t,0,2*Math.PI,!0),o.closePath(),o.fill(),i}(n._size||n.size||13),o=i.width/2,a=i.height/2,s=e,c={};for(var h in s.forEach(function(t){var e=Math.min(1,(void 0===t.count?1:t.count)/r).toFixed(2);c[e]=c[e]||[],c[e].push(t)}),c)if(!isNaN(h)){var u=c[h];t.beginPath(),n.withoutAlpha||(t.globalAlpha=h),u.forEach(function(e){var n=e.coordinate;t.globalAlpha=(void 0===e.count?1:e.count)/r,t.drawImage(i,n[0]-o,n[1]-a)})}}en.prototype.setMax=function(t){this.max=t||100},en.prototype.setMin=function(t){this.min=t||0},en.prototype.setMaxSize=function(t){this.maxSize=t||35},en.prototype.setMinSize=function(t){this.minSize=t||0},en.prototype.initPalette=function(){var t=this.gradient,e=new He(256,1),n=this.paletteCtx=e.getContext("2d"),r=n.createLinearGradient(0,0,256,1);for(var i in t)r.addColorStop(parseFloat(i),t[i]);n.fillStyle=r,n.fillRect(0,0,256,1)},en.prototype.getColor=function(t){var e=this.getImageData(t);return"rgba("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]/256+")"},en.prototype.getImageData=function(t){var e=this.paletteCtx.getImageData(0,0,256,1).data;if(void 0===t)return e;var n=this.max,r=this.min;t>n&&(t=n),t<r&&(t=r);var i=4*Math.floor((t-r)/(n-r)*255);return[e[i],e[i+1],e[i+2],e[i+3]]},en.prototype.getSize=function(t){var e=this.max,n=this.min,r=this.maxSize,i=this.minSize;return t>e&&(t=e),t<n&&(t=n),e>n?i+(t-n)/(e-n)*(r-i):r},en.prototype.getLegend=function(t){var e=this.gradient,n=t.width||20,r=t.height||180,i=new He(n,r),o=i.getContext("2d"),a=o.createLinearGradient(0,r,0,0);for(var s in e)a.addColorStop(parseFloat(s),e[s]);return o.fillStyle=a,o.fillRect(0,0,n,r),i};var an={draw:function(t,e,n){if(!(t.canvas.width<=0||t.canvas.height<=0)){t.strokeStyle="rgba(0,0,0,"+(n.strength||.3)+")";var r=new He(t.canvas.width,t.canvas.height),i=r.getContext("2d");i.scale(devicePixelRatio,devicePixelRatio),n=n||{},t.save();var o=new en({gradient:n.gradient});if(on(i,e,n),!n.absolute){var a=i.getImageData(0,0,t.canvas.width,t.canvas.height);nn(a.data,o.getImageData(),n),t.putImageData(a,0,0),t.restore()}o=null,r=null}},drawGray:on,colorize:nn},sn={interactive:!1,min:0,max:100,size:13,gradient:{.25:"rgb(0,0,255)",.55:"rgb(0,255,0)",.85:"yellow",1:"rgb(255,0,0)"},gridScale:.5},cn=2048,hn=function(t){function e(e,n,o,a){var s;Array.isArray(e)||(e=[e]);for(var c=1/0,h=1/0,u=-1/0,l=-1/0,d=[],v=0,p=e.length;v<p;v++){var g=e[v],y=g.coordinate||g.lnglat||g.xy;if(y){var m=a.coordinateToVector3(y);d.push(m);var x=m.x,b=m.y;c=Math.min(c,x),h=Math.min(h,b),u=Math.max(u,x),l=Math.max(l,b)}else console.warn("not find coordinate")}var _=(n=r.Util.extend({},sn,n,{layer:a,points:e})).gridScale,w=n.altitude,M=Math.abs(u-c),O=Math.abs(l-h),j=Math.max(M*_,O*_);j>cn&&(console.warn("gridScale: "+_+" it's too big. I hope it's a smaller value,canvas max size is 2048* "+cn),_=cn/(j/_));for(var S=Math.ceil(M*_),C=Math.ceil(O*_),A=S/M,T=C/O,P=[],k=0,B=d.length;k<B;k++){var I=d[k];I.x-=c,I.y-=h,I.x*=A,I.y*=T,I.y=C-I.y,P.push({coordinate:[I.x,I.y],count:e[k].count})}var L=new He(S,C),E=L.getContext("2d");an.drawGray(E,P,n);for(var z=E.getImageData(0,0,E.canvas.width,E.canvas.height),V=-1/0,R={},U=[],F=3,Z=z.data.length,G=0;F<Z;F+=4){var D=z.data[F];V=Math.max(V,D),U.push(D),D<=0&&(R[G]=1),G++}var H=new en({gradient:n.gradient});an.colorize(z.data,H.getImageData(),n),L=null,E=null;for(var q=new i.PlaneBufferGeometry(M,O,S-1,C-1),W=q.getIndex().array,K=q.attributes.position.array,N=[],Q=[],X=new i.Color,J=0,Y=K.length,$=0,tt=W.length,et=0,nt=z.data.length,rt=0;J<Math.max(Y,tt,nt);J+=3){if(J<Y){var it=U[rt];it>0&&(K[J+2]=it/V)}if($<tt){var ot=W[$],at=W[$+1],st=W[$+2];R[ot]&&R[at]&&R[st]||N.push(ot,at,st)}et<nt&&(X.setStyle("rgb("+z.data[et]+","+z.data[et+1]+","+z.data[et+2]+")"),Q.push(X.r,X.g,X.b)),$+=3,et+=4,rt++}q.setIndex(new i.Uint32BufferAttribute(N,1)),f(q,"color",new i.Float32BufferAttribute(Q,3,!0)),o.vertexColors=i.VertexColors,(s=t.call(this)||this)._initOptions(n),s._createMesh(q,o);var ct=a.distanceToVector3(w,w).x;return s.getObject3d().position.copy(new i.Vector3((c+u)/2,(h+l)/2,ct)),s}return c(e,t),e}(O),un=new i.Color,ln=1,fn=function(){function t(t){this.object3ds=[],this.layer=t,this.camera=t.getCamera(),this.renderer=t.getThreeRenderer(),this.pickingTexture=new i.WebGLRenderTarget(1,1),this.pickingScene=new i.Scene}var e=t.prototype;return e.getColor=function(){return un.setHex(ln),ln++,un},e.add=function(t){if(t){var e=t._colorIndex;e&&(this.object3ds[e]=t,this.pickingScene.add(t))}return this},e.remove=function(t){if(t){var e=t._colorIndex;e&&(this.object3ds[e]=null,this.pickingScene.remove(t))}return this},e.isEmpty=function(){if(0===this.pickingScene.children.length)return!0;for(var t=0,e=this.pickingScene.children.length;t<e;t++){var n=this.pickingScene.children[t];if(n){var r=n.__parent;if(r&&!0===r.getOptions().interactive)return!1}}return!0},e.pick=function(t){if(t&&!this.isEmpty()){for(var e=this.camera,n=this.renderer,r=this.pickingTexture,i=this.pickingScene,o=this.object3ds,a=this.layer,s=this.pickingScene.children.length,c=0;c<s;c++){var h=this.pickingScene.children[c];h&&h.__parent&&(h.__parent.picked=!1)}var u=a._getRenderer().canvas,l=u.width,f=u.height;l===r.width&&f===r.height||r.setSize(l,f),n.setRenderTarget(r),n.clear(),n.render(i,e);var d=new Uint8Array(4),v=window.devicePixelRatio,p=r.height-t.y*v;n.readRenderTargetPixels(r,Math.round(t.x*v),Math.round(p),1,1,d);var g=d[0]<<16|d[1]<<8|d[2],y=o[g];if(y)y.__parent&&(o[g].__parent.picked=!0);else for(var m=0;m<s;m++){var x=this.pickingScene.children[m];if(x&&x.__parent){var b=x.__parent;if(b._colorMap&&null!=b._colorMap[g]){b.picked=!0,b.index=b._colorMap[g];break}}}n.setRenderTarget(null)}},t}(),dn={altitude:0},vn=function(t){function e(e,n,i,o){var a;n=r.Util.extend({},dn,n,{layer:o,lineString:e}),(a=t.call(this)||this)._initOptions(n);for(var s=Ft(e)?qt(e):e.getCenter(),c=Kt(e,o,s).positionsV,h=[],u=0,l=c.length;u<l;u++){var f=c[u];u>0&&u<l-1&&h.push(f.x,f.y,f.z),h.push(f.x,f.y,f.z)}var d=new _;d.setPositions(h),a._setMaterialRes(o,i),a._createLine2(d,i);var v=n.altitude,p=o.distanceToVector3(v,v).x,g=o.coordinateToVector3(s,p);return a.getObject3d().position.copy(g),a._setPickObject3d(h,i.linewidth),a._init(),a}c(e,t);var n=e.prototype;return n._init=function(){var t=this,e=this.getLayer().getPick();this.on("add",function(){e.add(t.pickObject3d)}),this.on("remove",function(){e.remove(t.pickObject3d)})},n._setMaterialRes=function(t,e){var n=t.getMap().getSize();e.resolution.set(n.width,n.height)},n._setPickObject3d=function(t,e){var n=new _;n.setPositions(t);for(var r=this.getLayer().getPick().getColor(),o=[],a=0,s=t.length/3;a<s;a++)o.push(r.r,r.g,r.b);n.setColors(o);var c=new y({color:"#fff",linewidth:e,vertexColors:i.VertexColors});this._setMaterialRes(this.getLayer(),c);var h=r.getHex(),u=new w(n,c);u.position.copy(this.getObject3d().position),u._colorIndex=h,this.setPickObject3d(u)},n.identify=function(t){return this.picked},n.setSymbol=function(t){if(t&&t instanceof i.Material){t.needsUpdate=!0;var e=this.getMap().getSize();t.resolution.set(e.width,e.height),this.getObject3d().material=t}return this},e}(O),pn={altitude:0,colors:null},gn=function(t){function e(e,n,i,o){var a;Array.isArray(e)||(e=[e]);for(var s=[],c=e.length,h=0;h<c;h++){var u=e[h];s.push(Gt(u)?qt(u):u.getCenter())}var l=ne(s);n=r.Util.extend({},pn,n,{layer:o,lineStrings:e,coordinate:l});for(var f=[],d=0,v=[],p=[],g=0,y=[],m=0;m<c;m++){for(var x=Kt(e[m],o,l).positionsV,b=0,w=x.length;b<w;b++){var M=x[b];b>0&&b<w-1&&y.push(M.x,M.y,M.z),y.push(M.x,M.y,M.z)}var O=x.length+x.length-2,j=O;v[m]=[d,d+j],d+=j,p[m]={position:{count:O,start:g,end:g+3*O},instanceStart:{count:O,start:g,end:g+3*O},instanceEnd:{count:O,start:g,end:g+3*O},hide:!1},g+=3*O}(a=t.call(this)||this)._initOptions(n);var S=new _;S.setPositions(y),a._setMaterialRes(o,i),a._createLine2(S,i);var C=n.altitude,A=o.distanceToVector3(C,C).x,T=o.coordinateToVector3(l,A);return a.getObject3d().position.copy(T),a._faceMap=v,a._baseObjects=f,a._datas=e,a._geometriesAttributes=p,a.faceIndex=null,a.index=null,a._geometryCache=new _,a._geometryCache.setPositions(y),a._colorMap={},a.isHide=!1,a._initBaseObjectsEvent(f),a._setPickObject3d(y,i.linewidth),a._init(),a}c(e,t);var n=e.prototype;return n._init=function(){var t=this,e=this.getLayer().getPick();this.on("add",function(){e.add(t.pickObject3d)}),this.on("remove",function(){e.remove(t.pickObject3d)})},n._setMaterialRes=function(t,e){var n=t.getMap().getSize();e.resolution.set(n.width,n.height)},n._setPickObject3d=function(t,e){var n=new _;n.setPositions(t);for(var r=this.getLayer().getPick(),o=this._geometriesAttributes,a=[],s=0,c=o.length;s<c;s++){var h=r.getColor(),u=h.getHex();this._colorMap[u]=s;var l=o[s].position.count;this._datas[s].colorIndex=u;for(var f=0;f<l;f++)a.push(h.r,h.g,h.b)}n.setColors(a);var d=new y({color:"#fff",linewidth:e,vertexColors:i.VertexColors});this._setMaterialRes(this.getLayer(),d);var v=r.getColor().getHex(),p=new w(n,d);p.position.copy(this.getObject3d().position),p._colorIndex=v,this.setPickObject3d(p)},n.identify=function(t){return this.picked},n.setSymbol=function(t){if(t&&t instanceof i.Material){t.needsUpdate=!0;var e=this.getMap().getSize();t.resolution.set(e.width,e.height),this.getObject3d().material=t}return this},n.getSelectMesh=function(){var t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){var e=this._datas[t],n=r.Util.extend({},this.getOptions(),{index:t},Gt(e)?e.properties:e.getProperties());this._baseObjects[t]=new vn(e,n,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}},n._getIndex=function(t){return null==t&&(t=this.faceIndex||this.index),t},n._updateAttribute=function(t,e){for(var n=this._getHideGeometryIndex(e).indexs,r=this._geometryCache.attributes[e].array,i=r.length,o=0;o<i;o++)t.array[o]=r[o];for(var a=0;a<n.length;a++)for(var s=this._geometriesAttributes[n[a]][e],c=s.end,h=s.start;h<c;h++)t.array[h]=-1e5;return this},n._showGeometry=function(t,e){var n;if(t&&(n=t.getOptions().index),null!=n){var r=this._geometriesAttributes[n];if(r.hide===e)return this;r.hide=e;var i=this.getObject3d().geometry;this._updateAttribute(i.attributes.instanceStart,"instanceStart"),this._updateAttribute(i.attributes.instanceEnd,"instanceEnd"),i.attributes.instanceStart.data.needsUpdate=!0,i.attributes.instanceEnd.data.needsUpdate=!0,this.isHide=e}return this},e}(xe(O)),yn=Math.PI/180,mn=[[4e3,220],[2e3,100],[1e3,30],[500,15],[100,5],[50,2],[10,1],[5,.7],[2,.1],[1,.05],[.5,.02]],xn=["mousemove","click","mousedown","mouseup","dblclick","contextmenu","touchstart","touchmove","touchend"],bn=new i.Matrix4,_n=function(t){function e(){return t.apply(this,arguments)||this}c(e,t);var n=e.prototype;return n.draw=function(){this.renderScene()},n.drawOnInteracting=function(){this.renderScene()},n.coordinateToVector3=function(t,e){void 0===e&&(e=0);var n=this.getMap();if(!n)return null;t instanceof r.Coordinate||(t=new r.Coordinate(t));var o=n.coordinateToPoint(t,Mn(n));return new i.Vector3(o.x,o.y,e)},n.distanceToVector3=function(t,e,n){var o=this.getMap(),a=Mn(o),s=n||o.getCenter();s instanceof r.Coordinate||(s=new r.Coordinate(s));var c=o.locate(s,t,e),h=o.coordinateToPoint(s,a),u=o.coordinateToPoint(c,a),l=Math.abs(u.x-h.x)*r.Util.sign(t),f=Math.abs(u.y-h.y)*r.Util.sign(e);return new i.Vector3(l,f,0)},n.toShape=function(t){var e=this;if(!t)return null;if(t instanceof r.MultiPolygon)return t.getGeometries().map(function(t){return e.toShape(t)});var n=t.getCenter(),o=this.coordinateToVector3(n),a=t.getShell().map(function(t){return e.coordinateToVector3(t).sub(o)}),s=new i.Shape(a),c=t.getHoles();return c&&c.length>0&&(s.holes=c.map(function(t){var n=t.map(function(t){return e.coordinateToVector3(t).sub(o)});return new i.Shape(n)})),s},n.toExtrudeMesh=function(t,e,n,o){var a=this;if(!t)return null;if(t instanceof r.MultiPolygon)return t.getGeometries().map(function(t){return a.toExtrudeMesh(t,e,n,o)});var s=t.getCoordinates();s.forEach(function(t){for(var e=t.length-1;e>=1;e--)t[e].equals(t[e-1])&&t.splice(e,1)}),t.setCoordinates(s);var c=this.toShape(t),h=this.coordinateToVector3(t.getCenter());o=r.Util.isNumber(o)?o:e,o=this.distanceToVector3(o,o).x;var u=this.distanceToVector3(e,e).x,l={bevelEnabled:!1,bevelSize:1};l[parseInt(i.REVISION)>=93?"depth":"amount"]=o;var f=new i.ExtrudeGeometry(c,l),d=new i.BufferGeometry;d.fromGeometry(f);var v=new i.Mesh(d,n);return v.position.set(h.x,h.y,u-o),v},n.toExtrudePolygon=function(t,e,n){return new ae(t,e,n,this)},n.toBar=function(t,e,n){return new k(t,e,n,this)},n.toLine=function(t,e,n){return new Jt(t,e,n,this)},n.toExtrudeLine=function(t,e,n){return new $t(t,e,n,this)},n.toModel=function(t,e){return new ce(t,e,this)},n.toExtrudeLineTrail=function(t,e,n){return new ye(t,e,n,this)},n.toExtrudePolygons=function(t,e,n){return new we(t,e,n,this)},n.toPoint=function(t,e,n){return new Se(t,e,n,this)},n.toPoints=function(t,e,n){return new ke(t,e,n,this)},n.toBars=function(t,e,n){return new Ie(t,e,n,this)},n.toExtrudeLines=function(t,e,n){return new Ee(t,e,n,this)},n.toLines=function(t,e,n){return new Ve(t,e,n,this)},n.toThreeVectorTileLayer=function(t,e,n){return new Ke(t,e,n,this)},n.toTerrain=function(t,e,n){return new Ye(t,e,n,this)},n.toTerrainVectorTileLayer=function(t,e,n){return new tn(t,e,n,this)},n.toHeatMap=function(t,e,n){return new hn(t,e,n,this)},n.toFatLine=function(t,e,n){return new vn(t,e,n,this)},n.toFatLines=function(t,e,n){return new gn(t,e,n,this)},n.clearMesh=function(){var t=this.getScene();if(!t)return this;for(var e=t.children.length-1;e>=0;e--)t.children[e]instanceof i.Mesh&&t.remove(t.children[e]);return this},n.lookAt=function(t){var e=this._getRenderer();return e&&e.context.lookAt(t),this},n.getCamera=function(){var t=this._getRenderer();return t?t.camera:null},n.getScene=function(){var t=this._getRenderer();return t?t.scene:null},n.renderScene=function(){var t=this._getRenderer();return t&&(t.clearCanvas(),t.renderScene()),this},n.renderPickScene=function(){var t=this._getRenderer();if(t){var e=t.pick;e&&e.pick(this._containerPoint)}return this},n.getThreeRenderer=function(){var t=this._getRenderer();return t?t.context:null},n.getPick=function(){var t=this._getRenderer();return t?t.pick:null},n.addMesh=function(t,e){var n=this;if(void 0===e&&(e=!0),!t)return this;Array.isArray(t)||(t=[t]);var o=this.getScene();return t.forEach(function(t){t instanceof O?(o.add(t.getObject3d()),t.isAdd||(t.isAdd=!0,t._fire("add",{target:t})),t._animation&&r.Util.isFunction(t._animation)&&(n._animationBaseObjectMap[t.getObject3d().uuid]=t)):t instanceof i.Object3D&&o.add(t)}),this._zoomend(),e&&this.renderScene(),this},n.removeMesh=function(t,e){var n=this;if(void 0===e&&(e=!0),!t)return this;Array.isArray(t)||(t=[t]);var o=this.getScene();return t.forEach(function(t){t instanceof O?(o.remove(t.getObject3d()),t.isAdd&&(t.isAdd=!1,t._fire("remove",{target:t})),t._animation&&r.Util.isFunction(t._animation)&&delete n._animationBaseObjectMap[t.getObject3d().uuid]):t instanceof i.Object3D&&o.remove(t)}),e&&this.renderScene(),this},n._initRaycaster=function(){return this._raycaster||(this._raycaster=new i.Raycaster,this._mouse=new i.Vector2),this},n.identify=function(t,e){var n=this;if(!t)return console.error("coordinate is null,it should be Coordinate"),[];if(Array.isArray(t)&&(t=new r.Coordinate(t)),!(t instanceof r.Coordinate))return console.error("coordinate type is error,it should be Coordinate"),[];var o=this.getMap().coordToContainerPoint(t);this._containerPoint=o;var a=o.x,s=o.y;this._initRaycaster();var c=this._raycaster,h=this._mouse,u=this.getCamera(),f=this.getScene(),d=this.getMap().getSize();if(!f)return[];var v=d.height;h.x=a/d.width*2-1,h.y=-s/v*2+1,c.setFromCamera(h,u),function(t,e){l>113?t.params.Line.threshold=e:t.linePrecision=e}(c,this._getLinePrecision(this.getMap().getResolution()));var p=[],g=[];f.children.forEach(function(t){var e=t.__parent;e&&e.getOptions?e.getOptions().interactive&&e.isVisible()&&(e.identify&&r.Util.isFunction(e.identify)?g.push(e):p.push(t)):(t instanceof i.Mesh||t instanceof i.Group)&&p.push(t)});var y=[],m=c.intersectObjects(p,!0);m&&Array.isArray(m)&&m.length&&(y=m.map(function(t){var e=t.object,r=(e=n._recursionMesh(e)).__parent||e;return r.faceIndex=t.faceIndex,r.index=t.index,r})),this.renderPickScene(),g.length&&g.forEach(function(e){e.identify(t)&&y.push(e)});var x=(e=r.Util.extend({},e)).count;return r.Util.isNumber(x)&&x>0?y.slice(0,x):y},n._recursionMesh=function(t){for(;t&&!(t.parent instanceof i.Scene);)t=t.parent;return t||{}},n._getLinePrecision=function(t){void 0===t&&(t=10);for(var e=0,n=mn.length;e<n;e++){var r=mn[e];if(t>r[0])return r[1]}return.01},n._identifyBaseObjectEvents=function(t){if(!this.options.geometryEvents)return this;var e=this.map||this.getMap(),n=t.type,i=t.coordinate,o=r.Util.now();if(this._mousemoveTimeOut&&"mousemove"===n&&o-this._mousemoveTimeOut<16)return this;this._mousemoveTimeOut=o,e.resetCursor("default");var a=this.identify(i),s=this.getScene();if(0===a.length&&s)for(var c=0,h=s.children.length;c<h;c++){var u=(s.children[c]||{}).__parent;u&&u.fire("empty",Object.assign({},t,{target:u}))}if("mousemove"===n){a.length&&e.setCursor("pointer");var l=[];this._baseObjects&&this._baseObjects.forEach(function(t){var e=!0;a.forEach(function(n){t===n&&(e=!1)}),e&&l.push(t)}),l.forEach(function(e){e instanceof O&&(e.getSelectMesh?e.isHide||(e._mouseover=!1,e.fire("mouseout",Object.assign({},t,{target:e,type:"mouseout",selectMesh:null})),e.closeToolTip()):(e._mouseover=!1,e.fire("mouseout",Object.assign({},t,{target:e,type:"mouseout"})),e.closeToolTip()))}),a.forEach(function(e){if(e instanceof O){e._mouseover||(e.fire("mouseover",Object.assign({},t,{target:e,type:"mouseover",selectMesh:e.getSelectMesh?e.getSelectMesh():null})),e._mouseover=!0),e.fire(n,Object.assign({},t,{target:e,selectMesh:e.getSelectMesh?e.getSelectMesh():null}));var r=e.getToolTip();r&&!r._owner&&r.addTo(e),e.openToolTip(i)}})}else a.forEach(function(e){if(e instanceof O&&(e.fire(n,Object.assign({},t,{target:e,selectMesh:e.getSelectMesh?e.getSelectMesh():null})),"click"===n)){var r=e.getInfoWindow();r&&!r._owner&&r.addTo(e),e.openInfoWindow(i)}});return this._baseObjects=a,this},n._zoomend=function(){var t=this.getScene();if(t){var e=this.getMap().getZoom();t.children.forEach(function(t){var n=t.__parent;if(n&&n.getOptions){var r=n.getMinZoom(),i=n.getMaxZoom();e<r||e>i?(n.isVisible()&&(n.getObject3d().visible=!1),n._zoomVisible=!1):r<=e&&e<=i&&(n._visible&&(n.getObject3d().visible=!0),n._zoomVisible=!0)}})}},n.onAdd=function(){var e=this;t.prototype.onAdd.call(this);var n=this.map||this.getMap();return n?(xn.forEach(function(t){n.on(t,e._identifyBaseObjectEvents,e)}),this._needsUpdate=!0,this._animationBaseObjectMap||(this._animationBaseObjectMap={}),n.on("zooming zoomend",this._zoomend,this),this):this},n.onRemove=function(){var e=this;t.prototype.onRemove.call(this);var n=this.map||this.getMap();return n?(xn.forEach(function(t){n.off(t,e._identifyBaseObjectEvents,e)}),n.off("zooming zoomend",this._zoomend,this),this):this},n._callbackBaseObjectAnimation=function(){var t=this;if(t._animationBaseObjectMap)for(var e in t._animationBaseObjectMap)t._animationBaseObjectMap[e]._animation();return this},n._getFovRatio=function(){var t=this.getMap().getFov();return Math.tan(t/2*yn)},e}(r.CanvasLayer);_n.mergeOptions({renderer:"gl",doubleBuffer:!1,glOptions:null,geometryEvents:!0});var wn=function(t){function e(){return t.apply(this,arguments)||this}c(e,t);var n=e.prototype;return n.getPrepareParams=function(){return[this.scene,this.camera]},n.getDrawParams=function(){return[this.scene,this.camera]},n._drawLayer=function(){t.prototype._drawLayer.apply(this,arguments)},n.hitDetect=function(){return!1},n.createCanvas=function(){t.prototype.createCanvas.call(this),this.createContext()},n.createContext=function(){if(this.canvas.gl&&this.canvas.gl.wrap)this.gl=this.canvas.gl.wrap();else{var t=this.layer.options.glOptions||{alpha:!0,depth:!0,antialias:!0,stencil:!0};t.preserveDrawingBuffer=!0,this.gl=this.gl||this._createGLContext(this.canvas,t)}this._initThreeRenderer(),this.layer.onCanvasCreate(this.context,this.scene,this.camera)},n._initThreeRenderer=function(){var t=new i.WebGLRenderer({context:this.gl,alpha:!0});t.autoClear=!1,t.setClearColor(new i.Color(1,1,1),0),t.setSize(this.canvas.width,this.canvas.height),t.clear(),t.canvas=this.canvas,this.context=t;var e=this.scene=new i.Scene,n=this.layer.getMap(),r=n.getFov()*Math.PI/180,o=this.camera=new i.PerspectiveCamera(r,n.width/n.height,n.cameraNear,n.cameraFar);o.matrixAutoUpdate=!1,this._syncCamera(),e.add(o),this.pick=new fn(this.layer)},n.onCanvasCreate=function(){t.prototype.onCanvasCreate.call(this)},n.resizeCanvas=function(t){if(this.canvas){var e,n=this.getMap();e=t||n.getSize();var i=n.getDevicePixelRatio?n.getDevicePixelRatio():r.Browser.retina?2:1,o=this.canvas;o.height=i*e.height,o.width=i*e.width,this.layer._canvas&&o.style&&(o.style.width=e.width+"px",o.style.height=e.height+"px"),this.context.setSize(o.width,o.height)}},n.clearCanvas=function(){this.canvas&&this.context.clear()},n.prepareCanvas=function(){return this.canvas?this.clearCanvas():this.createCanvas(),this.layer.fire("renderstart",{context:this.context}),null},n.renderScene=function(){this.layer._callbackBaseObjectAnimation(),this._syncCamera(),this.context.render(this.scene,this.camera),this.completeRender()},n.remove=function(){delete this._drawContext,t.prototype.remove.call(this)},n._syncCamera=function(){var t=this.getMap(),e=this.camera;e.matrix.elements=t.cameraWorldMatrix,e.projectionMatrix.elements=t.projMatrix,e.projectionMatrixInverse.elements=bn.getInverse(e.projectionMatrix).elements},n._createGLContext=function(t,e){for(var n=["webgl2","webgl","experimental-webgl"],r=null,i=0;i<n.length;++i){try{r=t.getContext(n[i],e)}catch(o){}if(r)break}return r},e}(r.renderer.CanvasLayerRenderer);function Mn(t){return t.getGLZoom()}_n.registerRenderer("gl",wn),e.ThreeLayer=_n,e.ThreeRenderer=wn,e.BaseObject=O,Object.defineProperty(e,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.three v0.11.5, requires maptalks@>=0.39.0.")}(e,n("V0yk"),n("X9qW"))},vOrQ:function(t,e){t.exports=a}})});